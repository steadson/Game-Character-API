<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Game Character API Admin</title>
    <!-- Bootstrap CSS -->
     <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #ee8743;
            --primary-dark: #e06b1f;
            --primary-light: #f7a36e;
            --primary-hover: #d4bd3a;
            --secondary-color: #7209b7;
            --text-color: #333;
            --light-text: #6c757d;
            --background: #f8f9fa;
            --card-bg: #ffffff;
            --border-color: #e0e0e0;
            --error-color: #dc3545;
            --success-color: #28a745;
            --white: #ffffff;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
            --transition-normal: all 0.3s ease;
        }

        body {
            background-color: var(--background);
            font-family: 'Poppins', sans-serif;
            color: var(--text-color);
            min-height: 100vh;
        }
        .user-content-section {
        margin-left: 250px;
        padding: 20px;
        transition: margin-left 0.3s;
    }

        /* Sidebar styles */
        .sidebar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            height: 100vh;
            position: fixed;
            width: 250px;
            z-index: 1000;
            transition: var(--transition-normal);
            box-shadow: var(--shadow-md);
        }

        .sidebar-header {
            padding: 1.5rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header h2 {
            margin: 0;
            font-size: 1.2rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-menu {
            padding: 0.5rem 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 0.85rem 1.25rem;
            color: rgba(255, 255, 255, 0.85);
            text-decoration: none;
            text-transform: uppercase;
            border-left: 4px solid transparent;
            transition: var(--transition-normal);
            font-weight: 500;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
            margin: 0.25rem 0;
        }

        .menu-item:hover,
        .menu-item.active {
            background-color: rgba(255, 255, 255, 0.1);
            border-left-color: white;
            color: white;
        }

        .menu-item i {
            margin-right: 0.75rem;
            width: 20px;
            text-align: center;
            font-size: 1rem;
        }

        /* Main content styles */
        .main-content {
            margin-left: 250px;
            padding: 1.5rem;
            transition: var(--transition-normal);
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .content-header h1 {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--text-color);
            margin: 0;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background-color: var(--card-bg);
            border-radius: 50px;
            box-shadow: var(--shadow-sm);
            transition: var(--transition-normal);
        }

        .user-profile:hover {
            box-shadow: var(--shadow-md);
        }

        .user-profile i {
            font-size: 1.25rem;
            color: var(--primary-color);
        }

        .user-profile span {
            font-weight: 500;
            color: var(--text-color);
        }

        /* Mobile styles */
        .mobile-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1100;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.6rem;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            transition: var(--transition-normal);
        }

        .mobile-toggle:hover {
            background-color: var(--primary-dark);
        }

        .close-sidebar {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            position: absolute;
            top: 1rem;
            right: 1rem;
            transition: var(--transition-normal);
        }

        .close-sidebar:hover {
            transform: rotate(90deg);
        }

        /* Card styles */
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 1.5rem;
            transition: var(--transition-normal);
            overflow: hidden;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-3px);
        }

        .card-header {
            background-color: white;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
        }

        .card-title {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .view-all {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            transition: var(--transition-normal);
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
        }

        .view-all:hover {
            background-color: rgba(238, 135, 67, 0.1);
            color: var(--primary-dark);
        }

        .view-all i {
            font-size: 0.75rem;
            transition: transform 0.2s;
        }

        .view-all:hover i {
            transform: translateX(3px);
        }

        /* Stats grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 1.5rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #fff 0%, #f9f9f9 100%);
            border-radius: 12px;
            padding: 1.75rem;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
            transition: var(--transition-normal);
            border: 1px solid rgba(0, 0, 0, 0.03);
        }

        .stat-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-5px);
        }

        .stat-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--light-text);
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 0;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-icon {
            position: absolute;
            bottom: -0.75rem;
            right: 0.5rem;
            font-size: 4rem;
            opacity: 0.08;
        }

        .characters .stat-icon {
            color: var(--primary-color);
        }

        .documents .stat-icon {
            color: #20c997;
        }

        .users .stat-icon {
            color: #6610f2;
        }

        /* Table styles */
        .table {
            margin-bottom: 0;
        }

        .table thead th {
            border-top: none;
            border-bottom: 2px solid rgba(0, 0, 0, 0.05);
            font-weight: 600;
            color: var(--light-text);
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            padding: 1rem 1.5rem;
        }

        .table tbody td {
            padding: 1rem 1.5rem;
            vertical-align: middle;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .table tbody tr:last-child td {
            border-bottom: none;
        }

        .table tbody tr {
            transition: var(--transition-normal);
        }

        .table tbody tr:hover {
            background-color: rgba(0, 0, 0, 0.01);
        }

        .empty-state {
            text-align: center;
            padding: 3rem 0;
            color: var(--light-text);
        }

        .empty-state i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        /* Character grid */
        .character-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .character-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            transition: var(--transition-normal);
            border: 1px solid rgba(0, 0, 0, 0.03);
        }

        .character-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }

        .character-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            transition: var(--transition-normal);
        }

        .character-card:hover .character-image {
            transform: scale(1.05);
        }

        .character-details {
            padding: 1.25rem;
        }

        .character-details h3 {
            margin-top: 0;
            color: var(--primary-color);
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .character-details p {
            color: var(--text-color);
            margin-bottom: 0.75rem;
            line-height: 1.5;
        }

        .character-actions {
            display: flex;
            justify-content: space-between;
            padding: 0 1.25rem 1.25rem;
        }

        /* Override Bootstrap button colors */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            border: none;
            box-shadow: 0 2px 6px rgba(238, 135, 67, 0.4);
            transition: var(--transition-normal);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
            box-shadow: 0 4px 12px rgba(238, 135, 67, 0.6);
            transform: translateY(-2px);
        }

        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
            transition: var(--transition-normal);
        }

        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            border: none;
            box-shadow: 0 2px 6px rgba(220, 53, 69, 0.4);
            transition: var(--transition-normal);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #c82333 0%, #dc3545 100%);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.6);
            transform: translateY(-2px);
        }

        .btn-sm {
            padding: 0.35rem 0.75rem;
            font-size: 0.85rem;
            border-radius: 6px;
        }

        /* Responsive adjustments */
        @media (max-width: 992px) {
              .user-content-section {
        margin-left: 0;
        padding:10px;
        transition: margin-left 0.3s;
    }
            .sidebar {
                transform: translateX(-100%);
                box-shadow: var(--shadow-lg);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .mobile-toggle {
                display: block;
                z-index:0;
            }

            .close-sidebar {
                display: block;
            }

            .main-content {
                margin-left: 0;
                padding-top: 4rem;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .character-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
            
            .content-header {
               
            }
            
            .user-profile {
                align-self: flex-end;
            }
        }

        @media (max-width: 576px) {
            .user-content-section {
        margin-left: 0;
        padding:10px;
        transition: margin-left 0.3s;
    }
            #characters-section > div > h2{
                font-size: medium;
            }
            #add-character-btn{
                font-size:small
            }
            #documents-section > div > h2{
                font-size: medium;
            }
            #add-document-btn{
                font-size:small
            }
            .main-content {
                padding: 1rem;
                padding-top: 4rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .character-grid {
                grid-template-columns: 1fr;
            }
            
            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .view-all {
                align-self: flex-end;
            }
            
            .table thead th, 
            .table tbody td {
                padding: 0.75rem;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        /* Content section switching */
        .content-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content-section.active {
            display: block;
        }

        /* Loading spinner */
        .loading-spinner {
            text-align: center;
            padding: 50px 0;
        }

        .loading-spinner i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2050;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }
        
        .modal-content {
            background-color: var(--card-bg);
            margin: 1% auto;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 700px;
            animation: slideIn 0.3s;
            overflow: hidden;
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            margin: 0;
            margin-top:2rem;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .close {
            color: var(--light-text);
            font-size: 2rem;
            font-weight: 700;
            color:red;
            cursor: pointer;
            background: none;
            border: none;
            transition: var(--transition-normal);
        }
        
        .close:hover {
            color: var(--text-color);
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: 1.5rem;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 1.25rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Alert styles */
        .alert {
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
            border: none;
            box-shadow: var(--shadow-sm);
            animation: slideIn 0.3s;
        }
        
        .alert-success {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--success-color);
            border-left: 4px solid var(--success-color);
        }
        
        .alert-danger {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--error-color);
            border-left: 4px solid var(--error-color);
        }
        
        /* Form styles */
        .form-control {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: var(--transition-normal);
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(238, 135, 67, 0.15);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: block;
        }
        
        .form-text {
            color: var(--light-text);
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }
        
        /* Badge styles */
        .badge {
            padding: 0.4rem 0.75rem;
            font-weight: 500;
            border-radius: 50px;
            font-size: 0.75rem;
        }
    </style>
</head>

<body>
    <!-- Mobile Toggle Button -->
    <button class="mobile-toggle" id="mobile-toggle">
        <i class="fas fa-bars"></i>
    </button>

    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                 <h2>
                    <img src="/static/images/logo.png" alt="Game Character API Logo" style="height: 4rem; max-width: 100%;">
                    <span style="color: black; font-weight: bold;">
DÃ¦mon APIs</span>
                </h2>
                <button class="close-sidebar" id="close-sidebar">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="sidebar-menu">
                <a href="#" class="menu-item active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a href="#" class="menu-item" data-section="characters">
                    <i class="fas fa-gamepad"></i> Characters
                </a>
                <a href="#" class="menu-item" data-section="documents">
                    <i class="fas fa-file-alt"></i> Documents
                </a>
                <a href="#" class="menu-item" data-section="users">
                    <i class="fas fa-users"></i> Users
                </a>
                <a href="#" id="logout-btn" class="menu-item">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="content-header">
                <h1 id="section-title">Dashboard</h1>
                <div class="user-profile">
                    <i class="fas fa-user-circle"></i>
                    <span id="user-name">Loading...</span>
                </div>
            </div>

            <!-- Dashboard Section -->
            <div class="content-section active" id="dashboard-section">
                <!-- Stats Cards -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Overview</h2>
                    </div>
                    <div class="card-body">
                        <div class="stats-grid">
                            <div class="stat-card characters">
                                <div class="stat-title">Characters</div>
                                <div class="stat-value" id="character-count">0</div>
                                <i class="fas fa-gamepad stat-icon"></i>
                            </div>
                            <div class="stat-card documents">
                                <div class="stat-title">Documents</div>
                                <div class="stat-value" id="document-count">0</div>
                                <i class="fas fa-file-alt stat-icon"></i>
                            </div>
                            <div class="stat-card users">
                                <div class="stat-title">Users</div>
                                <div class="stat-value" id="user-count">0</div>
                                <i class="fas fa-users stat-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Characters -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Recent Characters</h2>
                        <a href="#" class="view-all" data-section="characters">
                            View All <i class="fas fa-chevron-right"></i>
                        </a>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Description</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-characters">
                                    <!-- Characters will be loaded here -->
                                    <tr>
                                        <td colspan="4" class="empty-state">
                                            <i class="fas fa-spinner fa-spin"></i>
                                            <p>Loading characters...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Recent Documents -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Recent Documents</h2>
                        <a href="#" class="view-all" data-section="documents">
                            View All <i class="fas fa-chevron-right"></i>
                        </a>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Type</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-documents">
                                    <!-- Documents will be loaded here -->
                                    <tr>
                                        <td colspan="4" class="empty-state">
                                            <i class="fas fa-spinner fa-spin"></i>
                                            <p>Loading documents...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Characters Section -->
            <div class="content-section" id="characters-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Game Characters</h2>
                    <button id="add-character-btn" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add New Character
                    </button>
                </div>

                <!-- Success/Error Messages -->
                <div id="character-success-message" class="alert alert-success" style="display: none;"></div>
                <div id="character-error-message" class="alert alert-danger" style="display: none;"></div>

                <!-- Characters Grid -->
                <div class="character-grid" id="character-grid">
                    <!-- Characters will be loaded here -->
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading characters...</p>
                    </div>
                </div>
            </div>

            <!-- Documents Section -->
            <div class="content-section" id="documents-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Documents</h2>
                    <button id="add-document-btn" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add New Document
                    </button>
                </div>
                 <!-- Document Auto-Refresh Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Document Auto-Refresh Settings</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <form id="refresh-settings-form">
                                    <div class="mb-3">
                                        <label for="refresh-interval" class="form-label">Refresh Interval</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="refresh-interval" min="1" value="24">
                                            <select class="form-select" id="refresh-interval-unit" style="max-width: 120px;">
                                                <option value="hours">Hours</option>
                                                <option value="days">Days</option>
                                                <option value="weeks">Weeks</option>
                                            </select>
                                        </div>
                                        <div class="form-text">URL documents will be automatically re-scraped and re-embedded at this interval.</div>
                                    </div>
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="auto-refresh-toggle" checked>
                                        <label class="form-check-label" for="auto-refresh-toggle">Enable Auto-Refresh</label>
                                    </div>
                                                                        <button type="submit" class="btn btn-primary" id="save-settings-btn">
                                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="settings-spinner"></span>
                                        <span id="settings-btn-text">Save Settings</span>
                                    </button>
                                    <button type="button" id="refresh-now-btn" class="btn btn-secondary ms-2">
                                        <i class="fas fa-sync-alt"></i> Refresh Now
                                    </button>
                                   
                                </form>
                            </div>
                            <div class="col-md-6">
                                <div id="refresh-status-card" style="display: none;">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="fas fa-sync-alt fa-spin me-2"></i>
                                                Document Refresh in Progress
                                            </h6>
                                            <div class="progress mb-3">
                                                <div id="refresh-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                                     role="progressbar" style="width: 0%;" 
                                                     aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                            </div>
                                            <p id="refresh-progress-text" class="mb-0">Processing documents: 0 of 0</p>
                                        </div>
                                    </div>
                                </div>
                                <div id="refresh-history" class="mt-3">
                                    <h6>Last Refresh: <span id="last-refresh-time">Never</span></h6>
                                    <p id="refresh-result" class="mb-0"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
              <!-- Success/Error Messages -->
    <div id="document-success-message" class="alert alert-success" style="display: none;"></div>
    <div id="document-error-message" class="alert alert-danger" style="display: none;"></div>
    
    <!-- Documents Grid -->
    <div class="document-grid" id="document-grid">
        <!-- Documents will be loaded here -->
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading documents...</p>
        </div>
    </div>
</div>
            </div>

                      <!-- Users Section -->
            <div class="user-content-section content-section" id="users-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>User Management</h2>
                </div>

                <!-- Success/Error Messages -->
                <div id="user-success-message" class="alert alert-success" style="display: none;"></div>
                <div id="user-error-message" class="alert alert-danger" style="display: none;"></div>

                <!-- Users Table -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">All Users</h3>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Status</th>
                                        <th>Role</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body">
                                    <!-- Users will be loaded here -->
                                    <tr>
                                        <td colspan="6" class="empty-state">
                                            <i class="fas fa-spinner fa-spin"></i>
                                            <p>Loading users...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Mobile sidebar toggle
        document.getElementById('mobile-toggle').addEventListener('click', function () {
            document.getElementById('sidebar').classList.add('active');
            //this.style.display = 'none';
        });

        document.getElementById('close-sidebar').addEventListener('click', function () {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('mobile-toggle').style.display = 'block';
        });

        // Check if user is logged in
        document.addEventListener('DOMContentLoaded', function () {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/';
                return;
            }

            // Load user profile and data
            loadUserProfile();
            loadDashboardData();

            // Setup navigation
            setupNavigation();

            // Setup logout button
            document.getElementById('logout-btn').addEventListener('click', function (e) {
                e.preventDefault();
                localStorage.removeItem('access_token');
                window.location.href = '/';
            });

            // Add character button
            document.getElementById('add-character-btn').addEventListener('click', function () {
                // Implement add character functionality
                console.log('Add character clicked');
                // You could open a modal or navigate to a character creation page
            });

            // Add document button
            document.getElementById('add-document-btn').addEventListener('click', function () {
                // Implement add document functionality
              
                // You could open a modal or navigate to a document upload page
            });
        });
        // Function to delete character
        function deleteCharacter(id) {
            if (confirm('Are you sure you want to delete this character?')) {
                fetch(`/api/v1/characters/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                        }
                    })
                    .then(response => {
                        if (response.ok) {
                            // Reload characters after successful deletion
                            loadCharacters();
                            // Show success message
                            const successMsg = document.getElementById('character-success-message');
                            successMsg.textContent = 'Character deleted successfully';
                            successMsg.style.display = 'block';
                            setTimeout(() => {
                                successMsg.style.display = 'none';
                            }, 3000);
                        } else {
                            throw new Error('Failed to delete character');
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting character:', error);
                        const errorMsg = document.getElementById('character-error-message');
                        errorMsg.textContent = 'Failed to delete character';
                        errorMsg.style.display = 'block';
                        setTimeout(() => {
                            errorMsg.style.display = 'none';
                        }, 3000);
                    });
            }
        }
        // Function to load characters

    function loadCharacters() {
        fetch('/api/v1/characters', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
            }
        })
        .then(response => response.json())
        .then(characters => {
            const characterGrid = document.getElementById('character-grid');

            if (characters.length === 0) {
                characterGrid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-gamepad"></i>
                        <p>No characters found. Create your first character!</p>
                    </div>
                `;
                return;
            }

            let html = '';
            characters.forEach(character => {
                // Use the image_url if available, otherwise use a placeholder
                const imageUrl = character.image_url || '/static/images/dinosaur1.png';

                html += `
                    <div class="character-card">
                        <div class="character-image-container" style="height: 180px; overflow: hidden; position: relative;">
                            <img src="${imageUrl}" alt="${character.name}" class="character-image" 
                                style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;" 
                                data-id="${character.id}"
                                onerror="this.onerror=null; this.src='/static/images/dinosaur1.png';">
                            <div class="image-overlay" style="position: absolute; top: 0; right: 0; padding: 5px; background-color: rgba(0,0,0,0.5); border-radius: 0 0 0 5px;">
                                <button class="btn btn-sm btn-light upload-image-btn" data-id="${character.id}" title="Upload Image">
                                    <i class="fas fa-upload"></i>
                                </button>
                            </div>
                        </div>
                        <div class="character-details">
                            <h3>${character.name}</h3>
                            <p>${character.description || 'No description available'}</p>
                            <p><small>Documents: ${character.document_count || 0}</small></p>
                        </div>
                        <div class="character-actions">
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary btn-sm view-character" data-id="${character.id}">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="btn btn-outline-primary btn-sm edit-character" data-id="${character.id}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            </div>
                            <button class="btn btn-danger btn-sm delete-character" data-id="${character.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });

                    characterGrid.innerHTML = html;

                    // Add event listeners to the buttons
                    document.querySelectorAll('.view-character').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const characterId = this.getAttribute('data-id');
                            viewCharacter(characterId);
                        });
                    });

                    // Add click event to character images for preview
                    document.querySelectorAll('.character-image').forEach(img => {
                        img.addEventListener('click', function () {
                            const characterId = this.getAttribute('data-id');
                            viewCharacter(characterId);
                        });
                    });

                    document.querySelectorAll('.edit-character').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const characterId = this.getAttribute('data-id');
                            editCharacter(characterId);
                        });
                    });

                    document.querySelectorAll('.delete-character').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const characterId = this.getAttribute('data-id');
                            deleteCharacter(characterId);
                        });
                    });
                })
                .catch(error => {
                    console.error('Error loading characters:', error);
                    document.getElementById('character-grid').innerHTML = `
                <div class="alert alert-danger">
                    Failed to load characters. Please try again later.
                </div>
            `;
                });
        }

        function setupNavigation() {
            // Get all menu items
            const menuItems = document.querySelectorAll('.sidebar-menu .menu-item');

            // Add click event to each menu item
            menuItems.forEach(item => {
                if (item.id !== 'logout-btn') { // Skip logout button
                    item.addEventListener('click', function (e) {
                        e.preventDefault();

                        // Remove active class from all menu items
                        menuItems.forEach(mi => mi.classList.remove('active'));

                        // Add active class to clicked menu item
                        this.classList.add('active');

                        // Get the section to show
                        const sectionToShow = this.getAttribute('data-section');

                        // Update the section title
                        document.getElementById('section-title').textContent =
                            sectionToShow.charAt(0).toUpperCase() + sectionToShow.slice(1);

                        // Hide all sections
                        document.querySelectorAll('.content-section').forEach(section => {
                            section.classList.remove('active');
                        });

                        // Show the selected section
                        document.getElementById(`${sectionToShow}-section`).classList.add('active');

                        // Load data for the section if needed
                        if (sectionToShow === 'characters') {
                            loadAllCharacters();
                        }

                        // Close the mobile sidebar if it's open
                        if (window.innerWidth < 992) {
                            document.getElementById('sidebar').classList.remove('active');
                        }
                    });
                }
            });

            // Also handle the "View All" links
            document.querySelectorAll('.view-all').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();

                    const sectionToShow = this.getAttribute('data-section');

                    // Activate the corresponding menu item
                    menuItems.forEach(mi => {
                        if (mi.getAttribute('data-section') === sectionToShow) {
                            mi.click();
                        }
                    });
                });
            });
        }
// Add this after your setupNavigation function

// // Function to load document refresh settings
// async function loadDocumentRefreshSettings() {
//     try {
//         const response = await fetch('/api/v1/document-refresh/settings', {
//             headers: {
//                 'Authorization': `Bearer ${localStorage.getItem('access_token')}`
//             }
//         });

//         if (!response.ok) {
//             throw new Error('Failed to load refresh settings');
//         }

//         const settings = await response.json();
//         console.log('Refresh settings:', settings);
        
//         // Update the form with the current settings
//         document.getElementById('refresh-interval').value = settings.hours;
//         document.getElementById('auto-refresh-toggle').checked = settings.enabled;
        
//         // Update last refresh time display
//         if (settings.last_refresh) {
//             const lastRefreshDate = new Date(settings.last_refresh);
//             document.getElementById('last-refresh-time').textContent = lastRefreshDate.toLocaleString();
//         } else {
//             document.getElementById('last-refresh-time').textContent = 'Never';
//         }
        
//         // Update refresh status
//         document.getElementById('refresh-result').textContent = 
//             settings.status === 'in_progress' ? 'Refresh in progress...' : 'Completed';
            
//         // Show/hide refresh status card
//         document.getElementById('refresh-status-card').style.display = 
//             settings.status === 'in_progress' ? 'block' : 'none';
//     } catch (error) {
//         console.error('Error loading refresh settings:', error);
//         document.getElementById('last-refresh-time').textContent = 'Error loading settings';
//     }
// }

// Function to setup document section
function setupDocumentSection() {
    // Load the current refresh settings
    //loadDocumentRefreshSettings();
    
    // Setup the form submission
    document.getElementById('refresh-settings-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const hours = parseInt(document.getElementById('refresh-interval').value);
        const enabled = document.getElementById('auto-refresh-toggle').checked;
        
        // Show loading state
        const spinner = document.getElementById('settings-spinner');
        const btnText = document.getElementById('settings-btn-text');
        spinner.classList.remove('d-none');
        btnText.textContent = 'Saving...';
        
        try {
            const response = await fetch('/api/v1/document-refresh/settings', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ hours, enabled })
            });
            
            if (!response.ok) {
                throw new Error('Failed to save settings');
            }
            
            const result = await response.json();
            console.log('Settings saved:', result);
            
            // Show success message
            const successMsg = document.getElementById('document-success-message');
            successMsg.textContent = 'Settings saved successfully';
            successMsg.style.display = 'block';
            setTimeout(() => {
                successMsg.style.display = 'none';
            }, 3000);
            
            // Reload the settings to confirm they were saved
            loadDocumentRefreshSettings();
        } catch (error) {
            console.error('Error saving settings:', error);
            const errorMsg = document.getElementById('document-error-message');
            errorMsg.textContent = 'Error saving settings: ' + error.message;
            errorMsg.style.display = 'block';
            setTimeout(() => {
                errorMsg.style.display = 'none';
            }, 3000);
        } finally {
            // Reset button state
            spinner.classList.add('d-none');
            btnText.textContent = 'Save Settings';
        }
    });
    
    // Setup the refresh now button
    document.getElementById('refresh-now-btn').addEventListener('click', async function() {
        try {
            const response = await fetch('/api/v1/document-refresh/now', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                }
            });
            
            if (!response.ok) {
                throw new Error('Failed to trigger refresh');
            }
            
            const result = await response.json();
            console.log('Refresh triggered:', result);
            
            // Show success message
            const successMsg = document.getElementById('document-success-message');
            successMsg.textContent = 'Document refresh process started';
            successMsg.style.display = 'block';
            setTimeout(() => {
                successMsg.style.display = 'none';
            }, 3000);
            
            // Start checking refresh status
            checkRefreshStatus();
        } catch (error) {
            console.error('Error triggering refresh:', error);
            const errorMsg = document.getElementById('document-error-message');
            errorMsg.textContent = 'Error triggering refresh: ' + error.message;
            errorMsg.style.display = 'block';
            setTimeout(() => {
                errorMsg.style.display = 'none';
            }, 3000);
        }
    });
    
    // Function to check refresh status
    async function checkRefreshStatus() {
        try {
            const response = await fetch('/api/v1/document-refresh/status', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                }
            });
            
            if (!response.ok) {
                throw new Error('Failed to get refresh status');
            }
            
            const status = await response.json();
            console.log('Refresh status:', status);
            
            // Update UI based on status
            if (status.status === 'in_progress') {
                // Show progress card
                document.getElementById('refresh-status-card').style.display = 'block';
                
                // Update progress bar
                const progressPercent = status.total > 0 ? Math.round((status.processed / status.total) * 100) : 0;
                const progressBar = document.getElementById('refresh-progress-bar');
                progressBar.style.width = `${progressPercent}%`;
                progressBar.textContent = `${progressPercent}%`;
                progressBar.setAttribute('aria-valuenow', progressPercent);
                
                // Update progress text
                document.getElementById('refresh-progress-text').textContent = 
                    `Processing documents: ${status.processed} of ${status.total}`;
                
                // Check again in 2 seconds
                setTimeout(checkRefreshStatus, 2000);
            } else {
                // Hide progress card
                document.getElementById('refresh-status-card').style.display = 'none';
                
                // Update last refresh time
                if (status.last_refresh) {
                    const lastRefreshDate = new Date(status.last_refresh);
                    document.getElementById('last-refresh-time').textContent = lastRefreshDate.toLocaleString();
                }
                
                // Update refresh result
                document.getElementById('refresh-result').textContent = 'Completed successfully';
            }
        } catch (error) {
            console.error('Error checking refresh status:', error);
            document.getElementById('refresh-status-card').style.display = 'none';
        }
    }
}

// Modify the setupNavigation function to call setupDocumentSection when documents section is shown
function setupNavigation() {
    // Get all menu items
    const menuItems = document.querySelectorAll('.sidebar-menu .menu-item');

    // Add click event to each menu item
    menuItems.forEach(item => {
        if (item.id !== 'logout-btn') { // Skip logout button
            item.addEventListener('click', function (e) {
                e.preventDefault();

                // Remove active class from all menu items
                menuItems.forEach(mi => mi.classList.remove('active'));

                // Add active class to clicked menu item
                this.classList.add('active');

                // Get the section to show
                const sectionToShow = this.getAttribute('data-section');

                // Update the section title
                document.getElementById('section-title').textContent =
                    sectionToShow.charAt(0).toUpperCase() + sectionToShow.slice(1);

                // Hide all sections
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });

                // Show the selected section
                document.getElementById(`${sectionToShow}-section`).classList.add('active');

                // Load data for the section if needed
                if (sectionToShow === 'characters') {
                    loadAllCharacters();
                } else if (sectionToShow === 'documents') {
                    // Setup document section when it's shown
                    setupDocumentSection();
                }

                // Close the mobile sidebar if it's open
                if (window.innerWidth < 992) {
                    document.getElementById('sidebar').classList.remove('active');
                }
            });
        }
    });

    // Rest of your existing setupNavigation code...
}
        async function loadUserProfile() {
            try {
                const response = await fetch('/api/v1/users/me', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load user profile');
                }

                const userData = await response.json();
                document.getElementById('user-name').textContent = userData.username;
            } catch (error) {
                console.error('Error loading user profile:', error);
                // If unauthorized, redirect to login
                if (error.message.includes('401')) {
                    localStorage.removeItem('access_token');
                    window.location.href = '/';
                }
            }
        }

        async function loadDashboardData() {
            try {
                // Load stats
                const statsResponse = await fetch('/api/v1/admin/stats', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });
              
                if (!statsResponse.ok) {
                    throw new Error('Failed to load stats');
                }

                const statsData = await statsResponse.json();
                console.log(statsData.total_characters, statsData.total_users, statsData.total_documents)
                document.getElementById('character-count').textContent =statsData.total_characters;
                document.getElementById('document-count').textContent = statsData.total_documents;
                document.getElementById('user-count').textContent = statsData.total_users;

                // Load recent characters
                const charactersResponse = await fetch('/api/v1/characters?limit=5', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });

                if (!charactersResponse.ok) {
                    throw new Error('Failed to load characters');
                }

                const charactersData = await charactersResponse.json();
                const charactersContainer = document.getElementById('recent-characters');
                charactersContainer.innerHTML = '';

                if (charactersData.length === 0) {
                    charactersContainer.innerHTML = `
                        <tr>
                            <td colspan="4" class="empty-state">
                                <i class="fas fa-user-slash"></i>
                                <p>No characters found. <button id="dashboard-add-character" class="btn btn-link p-0" style="color: var(--primary-color);">Create one</button>?</p>
                            </td>
                        </tr>
                    `;

                    document.getElementById('dashboard-add-character').addEventListener('click', function () {
                        document.querySelector('.menu-item[data-section="characters"]').click();
                        document.getElementById('add-character-btn').click();
                    });
                } else {
                    charactersData.forEach(character => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <i class="fas fa-gamepad" style="color: var(--primary-color);"></i>
                                    <span>${character.name}</span>
                                </div>
                            </td>
                            <td>${character.description.length > 50 ? character.description.substring(0, 50) + '...' : character.description}</td>
                            <td>${new Date(character.created_at).toLocaleDateString()}</td>
                            <td>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary btn-sm view-character" data-id="${character.id}">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm edit-character" data-id="${character.id}">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                </div>
                            </td>
                        `;
                        charactersContainer.appendChild(row);
                    });

                    // Add event listeners for character buttons
                    setupCharacterButtons();
                }

                // Load recent documents
                const documentsResponse = await fetch('/api/v1/documents?limit=5', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });

                if (!documentsResponse.ok) {
                    throw new Error('Failed to load documents');
                }

                const documentsData = await documentsResponse.json();
                const documentsContainer = document.getElementById('recent-documents');
                documentsContainer.innerHTML = '';

                if (documentsData.length === 0) {
                    documentsContainer.innerHTML = `
                        <tr>
                            <td colspan="4" class="empty-state">
                                <i class="fas fa-file-excel"></i>
                                <p>No documents found. <button id="dashboard-add-document" class="btn btn-link p-0" style="color: var(--primary-color);">Upload one</button>?</p>
                            </td>
                        </tr>
                    `;

                    document.getElementById('dashboard-add-document').addEventListener('click', function () {
                        document.querySelector('.menu-item[data-section="documents"]').click();
                        document.getElementById('add-document-btn').click();
                    });
                } else {
                    documentsData.forEach(doc => {
                        const row = document.createElement('tr');
                        let icon = 'fa-file-alt';
                        let badgeClass = 'bg-primary';
                        console.log('doc',doc)
                        // Determine icon based on document type
                        if (doc.document_type.toLowerCase().includes('image')) {
                            icon = 'fa-file-image';
                        } else if (doc.document_type.toLowerCase().includes('pdf')) {
                            icon = 'fa-file-pdf';
                        } else if (doc.document_type.toLowerCase().includes('excel') || doc.document_type
                            .toLowerCase().includes('sheet')) {
                            icon = 'fa-file-excel';
                            badgeClass = 'bg-success';
                        }

                        row.innerHTML = `
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <i class="fas ${icon}" style="color: var(--primary-color);"></i>
                                    <span>${doc.title}</span>
                                </div>
                            </td>
                            <td><span class="badge ${badgeClass}">${doc.document_type}</span></td>
                            <td>${new Date(doc.created_at).toLocaleDateString()}</td>
                            <td>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary btn-sm view-document" data-id="${doc.id}">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                   
                                </div>
                            </td>
                        `;
                        documentsContainer.appendChild(row);
                    });
                }
                setupDashboardEventListeners();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                // Show error state
                document.getElementById('recent-characters').innerHTML = `
                    <tr>
                        <td colspan="4" class="empty-state">
                            <i class="fas fa-exclamation-circle" style="color: #dc3545;"></i>
                            <p>Failed to load data. Please try again.</p>
                        </td>
                    </tr>
                `;
                document.getElementById('recent-documents').innerHTML = `
                    <tr>
                        <td colspan="4" class="empty-state">
                            <i class="fas fa-exclamation-circle" style="color: #dc3545;"></i>
                            <p>Failed to load data. Please try again.</p>
                        </td>
                    </tr>
                `;

                // If unauthorized, redirect to login
                if (error.message.includes('401')) {
                    localStorage.removeItem('access_token');
                    window.location.href = '/';
                }
            }
        }

        function setupDashboardEventListeners() {
    // Set up view document buttons in the dashboard
    document.querySelectorAll('#recent-documents .view-document').forEach(btn => {
        btn.addEventListener('click', function() {
            const documentId = this.getAttribute('data-id');
            console.log('Dashboard view document clicked, ID:', documentId);
            viewDocument(documentId);
        });
    });
    
    // Set up edit document buttons in the dashboard
    document.querySelectorAll('#recent-documents .edit-document').forEach(btn => {
        btn.addEventListener('click', function() {
            const documentId = this.getAttribute('data-id');
            console.log('Dashboard edit document clicked, ID:', documentId);
            editDocument(documentId);
        });
    });
    
    // Set up view character buttons in the dashboard
    document.querySelectorAll('#recent-characters .view-character').forEach(btn => {
        btn.addEventListener('click', function() {
            const characterId = this.getAttribute('data-id');
            console.log('Dashboard view character clicked, ID:', characterId);
            viewCharacter(characterId);
        });
    });
    
    // Set up edit character buttons in the dashboard
    document.querySelectorAll('#recent-characters .edit-character').forEach(btn => {
        btn.addEventListener('click', function() {
            const characterId = this.getAttribute('data-id');
            console.log('Dashboard edit character clicked, ID:', characterId);
            editCharacter(characterId);
        });
    });
}

        function setupCharacterButtons() {
            // View character
            document.querySelectorAll('.view-character').forEach(btn => {
                btn.addEventListener('click', function () {
                    const characterId = this.getAttribute('data-id');
                    // Implement view character functionality
                    console.log('View character:', characterId);
                    // You could open a modal or navigate to a character detail page
                });
            });

            // Edit character
            document.querySelectorAll('.edit-character').forEach(btn => {
                btn.addEventListener('click', function () {
                    const characterId = this.getAttribute('data-id');
                    // Implement edit character functionality
                    console.log('Edit character:', characterId);
                    // You could open a modal or navigate to a character edit page
                });
            });
        }

        async function loadAllCharacters() {
            try {
                const characterGrid = document.getElementById('character-grid');
                characterGrid.innerHTML = `
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading characters...</p>
                    </div>
                `;

                const response = await fetch('/api/v1/characters', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load characters');
                }

                const charactersData = await response.json();
                characterGrid.innerHTML = '';

                if (charactersData.length === 0) {
                    characterGrid.innerHTML = `
                        <div class="col-12 text-center py-5">
                            <i class="fas fa-user-slash" style="font-size: 3rem; color: #6c757d; margin-bottom: 1rem;"></i>
                            <p>No characters found. Click "Add New Character" to create one.</p>
                        </div>
                    `;
                } else {
                    let html = '';
                    charactersData.forEach(character => {
                        // Use the image_url if available, otherwise use a placeholder
                        let imageUrl = '/static/images/dinosaur1.png'; // Default placeholder
                        
                        if (character.image_url) {
                            // Check if the image_url already starts with /static
                            if (character.image_url.startsWith('/static')) {
                                imageUrl = character.image_url;
                            } else {
                                // If it's just a filename or relative path, prepend /static/uploads/characters/
                                imageUrl = `/static/uploads/characters/${character.image_url.split('/').pop()}`;
                            }
                        }

                        html += `
                            <div class="character-card">
                                <div class="character-image-container" style="height: 180px; overflow: hidden; position: relative;">
                                    <img src="${imageUrl}" alt="${character.name}" class="character-image" 
                                        style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;" 
                                        data-id="${character.id}"
                                        onerror="this.onerror=null; this.src='/static/images/dinosaur1.png';">
                                    <div class="image-overlay" style="position: absolute; top: 0; right: 0; padding: 5px; background-color: rgba(0,0,0,0.5); border-radius: 0 0 0 5px;">
                                        <button class="btn btn-sm btn-light upload-image-btn" data-id="${character.id}" title="Upload Image">
                                            <i class="fas fa-upload"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="character-details">
                                    <h3>${character.name}</h3>
                                    <p>${character.description || 'No description available'}</p>
                                    <p><small>Documents: ${character.document_count || 0}</small></p>
                                </div>
                                <div class="character-actions">
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-primary btn-sm view-character" data-id="${character.id}">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                        <button class="btn btn-outline-primary btn-sm edit-character" data-id="${character.id}">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                    </div>
                                    <button class="btn btn-danger btn-sm delete-character" data-id="${character.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    });

                    characterGrid.innerHTML = html;

                    // Add event listeners to the buttons
                    document.querySelectorAll('.view-character').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const characterId = this.getAttribute('data-id');
                            viewCharacter(characterId);
                        });
                    });

                    // Add click event to character images for preview
                    document.querySelectorAll('.character-image').forEach(img => {
                        img.addEventListener('click', function () {
                            const characterId = this.getAttribute('data-id');
                            viewCharacter(characterId);
                        });
                    });

                    // Add click event to upload image buttons
                    document.querySelectorAll('.upload-image-btn').forEach(btn => {
                        btn.addEventListener('click', function (e) {
                            e.stopPropagation(); // Prevent triggering the parent image click
                            const characterId = this.getAttribute('data-id');
                            uploadCharacterImage(characterId);
                        });
                    });

                    document.querySelectorAll('.edit-character').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const characterId = this.getAttribute('data-id');
                            editCharacter(characterId);
                        });
                    });

                    document.querySelectorAll('.delete-character').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const characterId = this.getAttribute('data-id');
                            if (confirm('Are you sure you want to delete this character? This action cannot be undone.')) {
                                deleteCharacter(characterId);
                            }
                        });
                    });
                }
            } catch (error) {
                console.error('Error loading characters:', error);
                document.getElementById('character-grid').innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;"></i>
                        <p>Failed to load characters. Please try again.</p>
                    </div>
                `;

                // If unauthorized, redirect to login
                if (error.message.includes('401')) {
                    localStorage.removeItem('access_token');
                    window.location.href = '/';
                }
            }
        }
        function setupCharacterActionListeners() {
            // View character
            document.querySelectorAll('.view-character').forEach(btn => {
                btn.addEventListener('click', function () {
                    const characterId = this.getAttribute('data-id');
                    viewCharacter(characterId);
                });
            });

            // Edit character
            document.querySelectorAll('.edit-character').forEach(btn => {
                btn.addEventListener('click', function () {
                    const characterId = this.getAttribute('data-id');
                    editCharacter(characterId);
                });
            });

            // Delete character
            document.querySelectorAll('.delete-character').forEach(btn => {
                btn.addEventListener('click', function () {
                    const characterId = this.getAttribute('data-id');
                    if (confirm(
                            'Are you sure you want to delete this character? This action cannot be undone.'
                        )) {
                        deleteCharacter(characterId);
                    }
                });
            });
        }

        // ... existing code ...

        async function viewCharacter(characterId) {
            try {
                const response = await fetch(`/api/v1/characters/${characterId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load character details');
                }

                const character = await response.json();

                // Use the existing characterPreviewModal instead of creating a new one
                document.getElementById('preview-character-name').textContent = character.name || '';
                document.getElementById('preview-character-id').textContent = character.character_id || '';
                document.getElementById('preview-character-description').textContent = character.description ||
                    'No description available';
                document.getElementById('preview-character-backstory').textContent = character.backstory ||
                    'No backstory available';
                document.getElementById('preview-character-personality').textContent = character.personality ||
                    'No personality traits defined';
                document.getElementById('preview-character-documents').textContent = character.document_count ||
                '0';
                document.getElementById('preview-character-system-prompt').textContent = character.system_prompt ||
                    'No system prompt defined';

                // Set the image with fallback
                const imageUrl = character.image_url || '/static/images/dinosaur1.png';
                document.getElementById('preview-character-image').src = imageUrl;
                document.getElementById('preview-character-image').onerror = function () {
                    this.src = '/static/images/dinosaur1.png';
                };

                // Set up the edit button
                document.getElementById('preview-edit-character-btn').setAttribute('data-id', character.id);
                document.getElementById('preview-edit-character-btn').onclick = function () {
                    // Close the preview modal
                    const previewModal = bootstrap.Modal.getInstance(document.getElementById(
                        'characterPreviewModal'));
                    if (previewModal) {
                        previewModal.hide();
                    }
                    // Open the edit modal
                    editCharacter(character.id);
                };

                // Show the modal
                const previewModal = new bootstrap.Modal(document.getElementById('characterPreviewModal'));
                previewModal.show();

                // Make sure the modal can be closed by clicking outside
                document.getElementById('characterPreviewModal').addEventListener('click', function (e) {
                    if (e.target === this) {
                        previewModal.hide();
                    }
                });

            } catch (error) {
                console.error('Error viewing character:', error);
                alert('Failed to load character details. Please try again.');
            }
        }

                function editCharacter(characterId) {
            // Fetch character data
            fetch(`/api/v1/characters/${characterId}`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                }
            })
            .then(response => response.json())
            .then(character => {
                // Populate form with character data
                document.getElementById('character-name').value = character.name || '';
                document.getElementById('character-id').value = character.character_id || '';
                document.getElementById('character-description').value = character.description || '';
                document.getElementById('character-backstory').value = character.backstory || '';
                document.getElementById('character-personality').value = character.personality || '';
                document.getElementById('character-system-prompt').value = character.system_prompt || '';
                
                // Update modal title and save button
                document.getElementById('character-modal-title').textContent = 'Edit Character';
                const saveBtn = document.getElementById('save-character-btn');
                saveBtn.textContent = 'Update Character';
                saveBtn.setAttribute('data-id', character.id);
                saveBtn.setAttribute('data-mode', 'edit');
                
                // Show the modal
                document.getElementById('character-modal').style.display = 'block';
            })
            .catch(error => {
                console.error('Error loading character for editing:', error);
                const errorMsg = document.getElementById('character-error-message');
                errorMsg.textContent = 'Failed to load character data for editing';
                errorMsg.style.display = 'block';
                setTimeout(() => {
                    errorMsg.style.display = 'none';
                }, 3000);
            });
        }
        
     



      

        async function deleteCharacter(characterId) {
            try {
                const response = await fetch(`/api/v1/characters/${characterId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to delete character');
                }

                // Show success message
                const successMessage = document.getElementById('character-success-message');
                successMessage.textContent = 'Character deleted successfully';
                successMessage.style.display = 'block';

                // Reload characters
                loadAllCharacters();

                // Auto-hide message after 5 seconds
                setTimeout(() => {
                    successMessage.style.display = 'none';
                }, 5000);
            } catch (error) {
                console.error('Error deleting character:', error);

                // Show error message
                const errorMessage = document.getElementById('character-error-message');
                errorMessage.textContent = 'Failed to delete character. Please try again.';
                errorMessage.style.display = 'block';

                // Auto-hide message after 5 seconds
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 5000);
            }
        }

        document.querySelectorAll('.menu-item').forEach(item => {
            if (item.getAttribute('data-section') === 'characters') {
                
                 item.addEventListener('click', loadAllCharacters);
            }
        });
    </script>
    <!-- ... existing code ... -->
    </div>
    </div>

    <!-- Character Modal -->
    <div id="character-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="character-modal-title">Add New Character</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="character-form">
                    <div class="form-group">
                        <label for="character-name">Name</label>
                        <input type="text" id="character-name" name="name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="character-id">Character ID</label>
                        <input type="text" id="character-id" name="character_id" class="form-control" required>
                        <small class="form-text text-muted">Unique identifier for this character</small>
                    </div>
                    <div class="form-group">
                        <label for="character-description">Description</label>
                        <textarea id="character-description" name="description" class="form-control" rows="3"
                            required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="character-backstory">Backstory</label>
                        <textarea id="character-backstory" name="backstory" class="form-control" rows="5"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="character-personality">Personality</label>
                        <textarea id="character-personality" name="personality" class="form-control"
                            rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="character-system-prompt">System Prompt</label>
                        <textarea id="character-system-prompt" name="system_prompt" class="form-control"
                            rows="5"></textarea>
                        <small class="form-text text-muted">Instructions for the AI when acting as this
                            character</small>
                    </div>
                    <div class="form-group">
                        <label for="character-image">Character Image (optional)</label>
                        <input type="file" id="character-image" name="image" class="form-control-file" accept="image/*">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary cancel-btn">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-character-btn">Save Character</button>
            </div>
        </div>
    </div>

     <div class="modal" id="characterPreviewModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="characterPreviewModalLabel">Character Preview</h5>
                    <button type="button" class="close" id="preview-close-btn">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <img id="preview-character-image" src="" alt="Character Image"
                                class="img-fluid rounded mb-3" style="max-height: 300px; width: auto;">
                        </div>
                        <div class="col-md-8">
                            <h3 id="preview-character-name"></h3>
                            <p><strong>ID:</strong> <span id="preview-character-id"></span></p>
                            <p><strong>Description:</strong> <span id="preview-character-description"></span></p>
                            <p><strong>Backstory:</strong> <span id="preview-character-backstory"></span></p>
                            <p><strong>Personality:</strong> <span id="preview-character-personality"></span></p>
                            <p><strong>Documents:</strong> <span id="preview-character-documents"></span></p>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h5>System Prompt:</h5>
                        <pre id="preview-character-system-prompt" class="p-3 bg-light rounded"
                            style="white-space: pre-wrap;"></pre>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary preview-cancel-btn">Close</button>
                    <button type="button" class="btn btn-primary" id="preview-edit-character-btn">Edit
                        Character</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Modal -->
<div id="document-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modal-title" class="modal-title">Add New Document</h2>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <form id="document-form">
                <div class="form-group">
                    <label for="document-title">Title</label>
                    <input type="text" id="document-title" name="title" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="document-description">Description</label>
                    <textarea id="document-description" name="description" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="document-type">Document Type</label>
                    <select id="document-type" name="document_type" class="form-control" required>
                        <option value="internal_documentation">Internal Documentation</option>
                        <option value="partner_documentation">Partner Documentation</option>
                        <option value="knowledge_base">Knowledge Base</option>
                        <option value="reference">Reference</option>
                        <option value="instruction">Instruction</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="content-type">Content Type</label>
                    <select id="content-type" name="content_type" class="form-control" required>
                        <option value="file">File Upload</option>
                        <option value="text">Text Content</option>
                        <option value="link">External Link</option>
                    </select>
                </div>
                
                <!-- File Upload Section (default) -->
                <div id="file-upload-section" class="content-type-section">
                    <div class="form-group">
                        <label for="document-file">Upload File</label>
                        <input type="file" id="document-file" name="file" class="form-control-file">
                    </div>
                </div>
                
                <!-- Text Content Section (hidden by default) -->
                <div id="text-content-section" class="content-type-section" style="display: none;">
                    <div class="form-group">
                        <label for="text-content">Text Content</label>
                        <textarea id="text-content" name="text_content" class="form-control" rows="10"></textarea>
                    </div>
                </div>
                
                <!-- Link URL Section (hidden by default) -->
                <div id="link-url-section" class="content-type-section" style="display: none;">
                    <div class="form-group">
                        <label for="link-url">External URL</label>
                        <input type="url" id="link-url" name="link_url" class="form-control" placeholder="https://example.com">
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary cancel-btn">Cancel</button>
            <button type="button" class="btn btn-primary" id="save-document-btn">Save Document</button>
        </div>
    </div>
</div>

<!-- Document Preview Modal -->
<div id="documentPreviewModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="documentPreviewModalLabel">Document Preview</h5>
            <span class="close" id="preview-document-close-btn">&times;</span>
        </div>
        <div class="modal-body">
            <div class="row">
                <div class="col-md-4 text-center">
                    <div id="document-icon-container" class="mb-3">
                        <i id="preview-document-icon" class="fas fa-file-alt fa-5x"></i>
                    </div>
                    <div id="document-status-container">
                        <span id="document-embedding-status" class="badge bg-secondary">Not Embedded</span>
                    </div>
                </div>
                <div class="col-md-8">
                    <h3 id="preview-document-title"></h3>
                    <p><strong>Type:</strong> <span id="preview-document-type"></span></p>
                    <p><strong>Content Type:</strong> <span id="preview-document-content-type"></span></p>
                    <p><strong>Description:</strong> <span id="preview-document-description"></span></p>
                    <p><strong>Original Filename:</strong> <span id="preview-document-filename"></span></p>
                    <p><strong>Uploaded:</strong> <span id="preview-document-created-at"></span></p>
                </div>
            </div>
            <div class="mt-3" id="document-content-preview">
                <h5>Content Preview:</h5>
                <div id="preview-document-content" class="p-3 bg-light rounded" style="max-height: 300px; overflow-y: auto;">
                    <p class="text-muted">Content preview not available</p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary preview-document-cancel-btn">Close</button>
            <!-- <a href="#" id="preview-download-document-btn" class="btn btn-info" download>Download</a> -->
        </div>
    </div>
</div>

    <!-- User Details Modal -->
    <div class="modal" id="userDetailsModal">

            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="userDetailsModalLabel">User Details</h5>
                     <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h4 id="user-details-username"></h4>
                            <p><strong>Email:</strong> <span id="user-details-email"></span></p>
                            <p><strong>Status:</strong> <span id="user-details-status"></span></p>
                            <p><strong>Role:</strong> <span id="user-details-role"></span></p>
                            <p><strong>Created:</strong> <span id="user-details-created"></span></p>
                        </div>
                        <div class="col-md-6">
                            <div class="stats-grid">
                                <div class="stat-card characters">
                                    <div class="stat-title">Characters</div>
                                    <div class="stat-value" id="user-character-count">0</div>
                                    <i class="fas fa-gamepad stat-icon"></i>
                                </div>
                                <div class="stat-card documents">
                                    <div class="stat-title">Documents</div>
                                    <div class="stat-value" id="user-document-count">0</div>
                                    <i class="fas fa-file-alt stat-icon"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- User's Characters -->
                    <div class="mt-4">
                        <h5>Characters Created</h5>
                        <div id="user-characters-container">
                            <p class="text-muted">Loading characters...</p>
                        </div>
                    </div>
                    
                    <!-- User's Documents -->
                    <div class="mt-4">
                        <h5>Documents Uploaded</h5>
                        <div id="user-documents-container">
                            <p class="text-muted">Loading documents...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary close-footer" id="user-details-close-btn-footer">Close</button>
                    <button type="button" class="btn btn-success" id="approve-user-btn" style="display: none;">Approve User</button>
                    <button type="button" class="btn btn-warning" id="deactivate-user-btn" style="display: none;">Deactivate User</button>
                    <button type="button" class="btn btn-success" id="activate-user-btn" style="display: none;">Activate User</button>
                </div>
            </div>
        
    </div>
<!--for document script-->
<script>
 // Add event listener for the documents menu item
    document.querySelectorAll('.menu-item').forEach(item => {
        if (item.getAttribute('data-section') === 'documents') {
            item.addEventListener('click', loadAllDocuments);
        }
    });

     document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('add-document-btn').addEventListener('click', function() {
            // Reset form
            document.getElementById('document-form').reset();
            
            // Update modal title and save button
            document.getElementById('modal-title').textContent = 'Add New Document';
            const saveBtn = document.getElementById('save-document-btn');
            saveBtn.textContent = 'Save Document';
            saveBtn.removeAttribute('data-id');
            saveBtn.setAttribute('data-mode', 'add');
            
            // Show the modal
            document.getElementById('document-modal').style.display = 'block';
        });
        
        // Close modal when clicking the X or Cancel button
        document.querySelectorAll('#document-modal .close, #document-modal .cancel-btn').forEach(element => {
            element.addEventListener('click', function() {
                document.getElementById('document-modal').style.display = 'none';
            });
        });
        
        // Close modal when clicking outside of it
        window.addEventListener('click', function(event) {
            if (event.target === document.getElementById('document-modal')) {
                document.getElementById('document-modal').style.display = 'none';
            }
        });
        
        // Toggle content type sections based on selection
        document.getElementById('content-type').addEventListener('change', function() {
            const contentType = this.value;
            document.querySelectorAll('.content-type-section').forEach(section => {
                section.style.display = 'none';
            });
            
            if (contentType === 'file') {
                document.getElementById('file-upload-section').style.display = 'block';
            } else if (contentType === 'text') {
                document.getElementById('text-content-section').style.display = 'block';
            } else if (contentType === 'link') {
                document.getElementById('link-url-section').style.display = 'block';
            }
        });
    });

    // Document functions
    async function loadAllDocuments() {
        try {
            const documentGrid = document.getElementById('document-grid');
            documentGrid.innerHTML = `
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading documents...</p>
                </div>
            `;

            const response = await fetch('/api/v1/documents', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                }
            });

            if (!response.ok) {
                throw new Error('Failed to load documents');
            }

            const documentsData = await response.json();
            console.log('documentdata,', documentsData)
            documentGrid.innerHTML = '';

            if (documentsData.length === 0) {
                documentGrid.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-file-excel" style="font-size: 3rem; color: #6c757d; margin-bottom: 1rem;"></i>
                        <p>No documents found. Click "Add New Document" to create one.</p>
                    </div>
                `;
            } else {
                let html = '';
                documentsData.forEach(doc => {
                    // Determine icon based on content type and file extension
                    let iconClass = 'fa-file-alt';
                    let bgColor = '#f8f9fa';
                    
                    if (doc.content_type === 'link') {
                        iconClass = 'fa-link';
                        bgColor = '#e3f2fd';
                    } else if (doc.content_type === 'text') {
                        iconClass = 'fa-file-text';
                        bgColor = '#fff3cd';
                    } else {
                        // For files, check extension
                        const ext = doc.original_filename.split('.').pop().toLowerCase();
                        if (['jpg', 'jpeg', 'png', 'gif', 'svg'].includes(ext)) {
                            iconClass = 'fa-file-image';
                            bgColor = '#d1e7dd';
                        } else if (ext === 'pdf') {
                            iconClass = 'fa-file-pdf';
                            bgColor = '#f8d7da';
                        } else if (['doc', 'docx'].includes(ext)) {
                            iconClass = 'fa-file-word';
                            bgColor = '#cfe2ff';
                        } else if (['xls', 'xlsx', 'csv'].includes(ext)) {
                            iconClass = 'fa-file-excel';
                            bgColor = '#d1e7dd';
                        }
                    }

                    // Create embedding status badge
                    let statusBadge = '';
                    if (doc.is_embedded) {
                        statusBadge = '<span class="badge bg-success">Embedded</span>';
                    } else if (doc.embedding_status === 'pending') {
                        statusBadge = '<span class="badge bg-warning">Pending</span>';
                    } else if (doc.embedding_status === 'failed') {
                        statusBadge = '<span class="badge bg-danger">Failed</span>';
                    } else {
                        statusBadge = '<span class="badge bg-secondary">Not Embedded</span>';
                    }

                    html += `
                        <div class="document-card">
                            <div class="document-icon-container" style="height: 180px; display: flex; align-items: center; justify-content: center; background-color: ${bgColor}; position: relative;">
                                <i class="fas ${iconClass} fa-5x" style="opacity: 0.7;"></i>
                                <div class="status-badge" style="position: absolute; top: 10px; right: 10px;">
                                    ${statusBadge}
                                </div>
                            </div>
                            <div class="document-details">
                                <h3>${doc.title}</h3>
                                <p>${doc.description || 'No description available'}</p>
                                <p><small>Type: ${doc.document_type.replace('_', ' ')}</small></p>
                            </div>
                            <div class="document-actions">
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary btn-sm view-document" data-id="${doc.id}">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    ${doc.is_embedded ? 
                                        `<button class="btn btn-info btn-sm re-embed-document" data-id="${doc.id}">
                                            <i class="fas fa-sync"></i> Re-embed
                                        </button>` : 
                                        `<button class="btn btn-warning btn-sm embed-document" data-id="${doc.id}" >
                                            <i class="fas fa-database"></i> Embed Now
                                        </button>`
                                    }
                                </div>
                                <button class="btn btn-danger btn-sm delete-document" data-id="${doc.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });

                documentGrid.innerHTML = html;

                // Add event listeners to the buttons
                setupDocumentActionListeners();
            }
        } catch (error) {
            console.error('Error loading documents:', error);
            document.getElementById('document-grid').innerHTML = `
                <div class="col-12 text-center py-5">
                    <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;"></i>
                    <p>Failed to load documents. Please try again.</p>
                </div>
            `;

            // If unauthorized, redirect to login
            if (error.message.includes('401')) {
                localStorage.removeItem('access_token');
                window.location.href = '/';
            }
        }
    }

    function setupDocumentActionListeners() {
        // View document
        document.querySelectorAll('.view-document').forEach(btn => {
            btn.addEventListener('click', function() {
                const documentId = this.getAttribute('data-id');
                viewDocument(documentId);
            });
        });
 // Embed document
        document.querySelectorAll('.embed-document').forEach(btn => {
            btn.addEventListener('click', function() {
                const documentId = this.getAttribute('data-id');
                embedDocument(documentId, false);
            });
        });

        // Re-embed document
        document.querySelectorAll('.re-embed-document').forEach(btn => {
            btn.addEventListener('click', function() {
                const documentId = this.getAttribute('data-id');
                embedDocument(documentId, true);
            });
        });

        // Delete document
        document.querySelectorAll('.delete-document').forEach(btn => {
            btn.addEventListener('click', function() {
                const documentId = this.getAttribute('data-id');
                if (confirm('Are you sure you want to delete this document? This action cannot be undone.')) {
                    deleteDocument(documentId);
                }
            });
        });
    }

        async function embedDocument(documentId, isReembed) {
        try {
            console.log('embedding')
            // Find the button that was clicked and update its state
            const button = isReembed ? 
                document.querySelector(`.re-embed-document[data-id="${documentId}"]`) : 
                document.querySelector(`.embed-document[data-id="${documentId}"]`);
            
            if (button) {
                // Disable the button and show loading state
                button.disabled = true;
                const originalText = button.innerHTML;
                button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${isReembed ? 'Re-embedding...' : 'Embedding...'}`;
                
                // Find the status badge for this document
                const documentCard = button.closest('.document-card');
                const statusBadge = documentCard.querySelector('.status-badge');
                if (statusBadge) {
                    statusBadge.innerHTML = '<span class="badge bg-warning">Processing...</span>';
                }
            }
            
            // Send request to backend to start embedding
            const response = await fetch(`/api/v1/embed/documents/${documentId}/embed`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ reembed: isReembed })
            });

            if (!response.ok) {
                 const documentCard = button.closest('.document-card');
                 const statusBadge = documentCard.querySelector('.status-badge');
                 if (statusBadge) {
                    statusBadge.innerHTML = '<span class="badge bg-warning">Pending</span>';
                }
                throw new Error('Failed to start embedding process');
            }

            const result = await response.json();
            
            // Show success message
            const successMessage = document.getElementById('document-success-message');
            successMessage.textContent = result.message || 'Document embedding process started successfully';
            successMessage.style.display = 'block';
            
            // Auto-hide message after 5 seconds
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 5000);
            
            // Reload the document list to show updated status
            // We could optimize this to just update the specific document card
            loadAllDocuments();
            
        } catch (error) {
            console.error('Error embedding document:', error);
            
            // Show error message
            const errorMessage = document.getElementById('document-error-message');
            errorMessage.textContent = 'Failed to start embedding process. Please try again.';
            errorMessage.style.display = 'block';
            
            // Auto-hide message after 5 seconds
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
            
            // Reset the button state
            const button = isReembed ? 
                document.querySelector(`.re-embed-document[data-id="${documentId}"]`) : 
                document.querySelector(`.embed-document[data-id="${documentId}"]`);
            
            if (button) {
                button.disabled = false;
                button.innerHTML = isReembed ? 
                    '<i class="fas fa-sync"></i> Re-embed' : 
                    '<i class="fas fa-database"></i> Embed Now';
            }
        }
    }

    async function viewDocument(documentId) {
         
    
    if (!documentId) {
        console.error('No document ID provided to viewDocument function');
        alert('Error: Could not load document details. Missing document ID.');
        return;
    }
        try {
            const response = await fetch(`/api/v1/documents/${documentId}`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                }
            });

            if (!response.ok) {
                throw new Error('Failed to load document details');
            }

            const doc = await response.json();
            
            // Set document details in the preview modal
            document.getElementById('preview-document-title').textContent = doc.title || '';
            document.getElementById('preview-document-type').textContent = doc.document_type.replace('_', ' ') || '';
            document.getElementById('preview-document-content-type').textContent = doc.content_type || '';
            document.getElementById('preview-document-description').textContent = doc.description || 'No description available';
            document.getElementById('preview-document-filename').textContent = doc.original_filename || '';
            document.getElementById('preview-document-created-at').textContent = new Date(doc.created_at).toLocaleString();
            
            // Set embedding status
            const statusElement = document.getElementById('document-embedding-status');
            if (doc.is_embedded) {
                statusElement.className = 'badge bg-success';
                statusElement.textContent = 'Embedded';
            } else if (doc.embedding_status === 'pending') {
                statusElement.className = 'badge bg-warning';
                statusElement.textContent = 'Pending Embedding';
            } else if (doc.embedding_status === 'failed') {
                statusElement.className = 'badge bg-danger';
                statusElement.textContent = 'Embedding Failed';
            } else {
                statusElement.className = 'badge bg-secondary';
                statusElement.textContent = 'Not Embedded';
            }
            
            // Set document icon based on content type and file extension
            let iconClass = 'fa-file-alt';
            if (doc.content_type === 'link') {
                iconClass = 'fa-link';
            } else if (doc.content_type === 'text') {
                iconClass = 'fa-file-text';
            } else {
                // For files, check extension
                const ext = doc.original_filename.split('.').pop().toLowerCase();
                if (['jpg', 'jpeg', 'png', 'gif', 'svg'].includes(ext)) {
                    iconClass = 'fa-file-image';
                } else if (ext === 'pdf') {
                    iconClass = 'fa-file-pdf';
                } else if (['doc', 'docx'].includes(ext)) {
                    iconClass = 'fa-file-word';
                } else if (['xls', 'xlsx', 'csv'].includes(ext)) {
                    iconClass = 'fa-file-excel';
                }
            }
            document.getElementById('preview-document-icon').className = `fas ${iconClass} fa-5x`;
            
            
            
            // Set up content preview
            const contentPreview = document.getElementById('preview-document-content');
            if (doc.content_type === 'text') {
                // For text content, try to fetch and display the content
                try {
                    const contentResponse = await fetch(`/api/v1/documents/${documentId}/content`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                        }
                    });
                    
                    if (contentResponse.ok) {
                        const textContent = await contentResponse.text();
                        contentPreview.innerHTML = `<pre style="white-space: pre-wrap;">${textContent}</pre>`;
                    } else {
                        contentPreview.innerHTML = '<p class="text-muted">Content preview not available</p>';
                    }
                } catch (error) {
                    contentPreview.innerHTML = '<p class="text-muted">Content preview not available</p>';
                }
            } else if (doc.content_type === 'link') {
                //contentPreview.innerHTML = `<p><a href="${doc.file_path}" target="_blank">${doc.file_path}</a></p>`;
                contentPreview.innerHTML = '<p class="text-muted">Content preview not available</p>';
            } else {
                // For files, show a message that preview is not available
                contentPreview.innerHTML = '<p class="text-muted">Content preview not available for this file type</p>';
            }
            
         
            
            // Show the modal
           document.getElementById('documentPreviewModal').style.display = 'block';
        //   const previewModal = new bootstrap.Modal(document.getElementById('documentPreviewModal'));
        // previewModal.show();
        
       
           
            
        } catch (error) {
            console.error('Error viewing document:', error);
            alert('Failed to load document details. Please try again.');
        }
    }

    

    async function deleteDocument(documentId) {
        try {
            const response = await fetch(`/api/v1/documents/${documentId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                }
            });

            if (!response.ok) {
                throw new Error('Failed to delete document');
            }

            // Show success message
            const successMessage = document.getElementById('document-success-message');
            successMessage.textContent = 'Document deleted successfully';
            successMessage.style.display = 'block';

            // Reload documents
            loadAllDocuments();

            // Auto-hide message after 5 seconds
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 5000);
        } catch (error) {
            console.error('Error deleting document:', error);

            // Show error message
            const errorMessage = document.getElementById('document-error-message');
            errorMessage.textContent = 'Failed to delete document. Please try again.';
            errorMessage.style.display = 'block';

            // Auto-hide message after 5 seconds
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }
    }

    // Function to show the appropriate content type section
    function showContentTypeSection(contentType) {
        // Hide all content type sections
        document.querySelectorAll('.content-type-section').forEach(section => {
            section.style.display = 'none';
        });
        
        // Show the selected content type section
        if (contentType === 'file') {
            document.getElementById('file-upload-section').style.display = 'block';
        } else if (contentType === 'text') {
            document.getElementById('text-content-section').style.display = 'block';
        } else if (contentType === 'link') {
            document.getElementById('link-url-section').style.display = 'block';
        }
    }

    // Add event listener for content type change
    document.getElementById('content-type').addEventListener('change', function() {
        showContentTypeSection(this.value);
    });

    // Add event listener for add document button
    document.getElementById('add-document-btn').addEventListener('click', function() {
        // Reset form
        document.getElementById('document-form').reset();
        
        // Reset content type sections
        showContentTypeSection('file');
        
        // Update modal title and save button
        document.getElementById('document-modal-title').textContent = 'Add New Document';
        const saveBtn = document.getElementById('save-document-btn');
        saveBtn.textContent = 'Save Document';
       
        
        // Show the modal
        // const documentModal = new bootstrap.Modal(document.getElementById('document-modal'));
        // documentModal.show();
         document.getElementById('document-modal').style.display = 'block';
    });

    // Add event listener for save document button
    document.getElementById('save-document-btn').addEventListener('click', async function() {
        
        
        // Get form data
        const title = document.getElementById('document-title').value;
        const description = document.getElementById('document-description').value;
        const documentType = document.getElementById('document-type').value;
        const contentType = document.getElementById('content-type').value;
        
        // Validate form
        if (!title) {
            alert('Please enter a title');
            return;
        }
        
        if (!documentType) {
            alert('Please select a document type');
            return;
        }
        
        // Create FormData object
        const formData = new FormData();
        formData.append('title', title);
        formData.append('description', description);
        formData.append('document_type', documentType);
        formData.append('content_type', contentType);
        
        // Add content based on content type
        if (contentType === 'file') {
            const fileInput = document.getElementById('document-file');
            if (fileInput.files.length === 0 && mode === 'add') {
                alert('Please select a file');
                return;
            }
            
            if (fileInput.files.length > 0) {
                formData.append('file', fileInput.files[0]);
            }
        } else if (contentType === 'text') {
            const textContent = document.getElementById('text-content').value;
            if (!textContent) {
                alert('Please enter text content');
                return;
            }
            formData.append('text_content', textContent);
        } else if (contentType === 'link') {
            const linkUrl = document.getElementById('link-url').value;
            if (!linkUrl) {
                alert('Please enter a URL');
                return;
            }
            formData.append('link_url', linkUrl);
        }
        
        try {
            let url = '/api/v1/documents';
            let method = 'POST';
            
            
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                },
                body: formData
            });
            
            if (!response.ok) {
                throw new Error('Failed to save document');
            }
            
            // Close the modal
            document.getElementById('document-modal').style.display = 'none';
            
            // Show success message
          const successMessage = document.getElementById('document-success-message');
        successMessage.textContent = 'Document added successfully';
        successMessage.style.display = 'block';
            
            // Reload documents
            loadAllDocuments();
            
            // Auto-hide message after 5 seconds
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 5000);
            
        } catch (error) {
            console.error('Error saving document:', error);
            
            // Show error message
            const errorMessage = document.getElementById('document-error-message');
            errorMessage.textContent = 'Failed to save document. Please try again.';
            errorMessage.style.display = 'block';
            
            // Auto-hide message after 5 seconds
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }
    });

    // Add event listeners for modal close buttons
    document.querySelectorAll('.close, .cancel-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.getElementById('document-modal').style.display='none'
            const modal = this.closest('.modal');
            // const bootstrapModal = bootstrap.Modal.getInstance(modal);
            // if (bootstrapModal) {
            //     bootstrapModal.hide();
            // }
        });
    });

    // Add event listeners for document preview modal close buttons
    document.querySelectorAll('#preview-document-close-btn, .preview-document-cancel-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const modal = document.getElementById('documentPreviewModal');
            // const bootstrapModal = bootstrap.Modal.getInstance(modal);
            // if (bootstrapModal) {
            //     bootstrapModal.hide();
            // }
             modal.style.display = 'none';
        });
    });

    // Add CSS for document grid
    const style = document.createElement('style');
    style.textContent = `
        .document-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .document-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            background-color: white;
        }
        
        .document-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .document-details {
            padding: 15px;
        }
        
        .document-details h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .document-details p {
            margin-bottom: 5px;
            color: #666;
            font-size: 14px;
        }
        
        .document-actions {
            padding: 10px 15px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .loading-spinner {
            text-align: center;
            padding: 50px 0;
            color: #666;
        }
        
        .loading-spinner i {
            font-size: 2rem;
            margin-bottom: 10px;
        }
    `;
    document.head.appendChild(style);
</script>

    <!-- Update the loadCharacters function in your script section -->
    <script>
        // ... existing code ...

        // Function to load characters
        function loadCharacters() {
            fetch('/api/v1/characters', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                })
                .then(response => response.json())
                .then(characters => {
                    const characterGrid = document.getElementById('character-grid');

                    if (characters.length === 0) {
                        characterGrid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-gamepad"></i>
                        <p>No characters found. Create your first character!</p>
                    </div>
                `;
                        return;
                    }

                    let html = '';
                    characters.forEach(character => {
                        // Use the image_url if available, otherwise use a placeholder
                       let imageUrl = '/static/images/dinosaur1.png'; // Default placeholder
                        
                        if (character.image_url) {
                            // Check if the image_url already starts with /static
                            if (character.image_url.startsWith('/static')) {
                                imageUrl = character.image_url;
                            } else {
                                // If it's just a filename or relative path, prepend /static/uploads/characters/
                                imageUrl = `/static/uploads/characters/${character.image_url.split('/').pop()}`;
                            }
                        }
                        html += `
                    <div class="character-card">
                        <div class="character-image-container" style="height: 180px; overflow: hidden; position: relative;">
                            <img src="${imageUrl}" alt="${character.name}" class="character-image" style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;" data-id="${character.id}">
                            <div class="image-overlay" style="position: absolute; top: 0; right: 0; padding: 5px; background-color: rgba(0,0,0,0.5); border-radius: 0 0 0 5px;">
                                <button class="btn btn-sm btn-light upload-image-btn" data-id="${character.id}" title="Upload Image">
                                    <i class="fas fa-upload"></i>
                                </button>
                            </div>
                        </div>
                        <div class="character-details">
                            <h3>${character.name}</h3>
                            <p>${character.description || 'No description available'}</p>
                            <p><small>Documents: ${character.document_count || 0}</small></p>
                        </div>
                        <div class="character-actions">
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary btn-sm view-character" data-id="${character.id}">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="btn btn-outline-primary btn-sm edit-character" data-id="${character.id}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            </div>
                            <button class="btn btn-danger btn-sm delete-character" data-id="${character.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                    });

                    characterGrid.innerHTML = html;

                    // Add event listeners to the buttons
                    document.querySelectorAll('.view-character').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const characterId = this.getAttribute('data-id');
                            viewCharacter(characterId);
                        });
                    });

                    // Add click event to character images for preview
                    document.querySelectorAll('.character-image').forEach(img => {
                        img.addEventListener('click', function () {
                            const characterId = this.getAttribute('data-id');
                            viewCharacter(characterId);
                        });
                    });

                    // Add click event to upload image buttons
                    document.querySelectorAll('.upload-image-btn').forEach(btn => {
                        btn.addEventListener('click', function (e) {
                            e.stopPropagation(); // Prevent triggering the parent image click
                            const characterId = this.getAttribute('data-id');
                            uploadCharacterImage(characterId);
                        });
                    });

                    document.querySelectorAll('.edit-character').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const characterId = this.getAttribute('data-id');
                            editCharacter(characterId);
                        });
                    });

                    document.querySelectorAll('.delete-character').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const characterId = this.getAttribute('data-id');
                            deleteCharacter(characterId);
                        });
                    });
                })
                .catch(error => {
                    console.error('Error loading characters:', error);
                    document.getElementById('character-grid').innerHTML = `
                <div class="alert alert-danger">
                    Failed to load characters. Please try again later.
                </div>
            `;
                });
        }

                // Function to view character details
        function viewCharacter(id) {
            fetch(`/api/v1/characters/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                })
                .then(response => response.json())
                .then(character => {
                    // Populate the preview modal
                    document.getElementById('preview-character-name').textContent = character.name;
                    document.getElementById('preview-character-id').textContent = character.character_id;
                    document.getElementById('preview-character-description').textContent = character.description ||
                        'No description available';
                    document.getElementById('preview-character-backstory').textContent = character.backstory ||
                        'No backstory available';
                    document.getElementById('preview-character-personality').textContent = character.personality ||
                        'No personality traits defined';
                    document.getElementById('preview-character-system-prompt').textContent = character
                        .system_prompt || 'No system prompt defined';
                    document.getElementById('preview-character-documents').textContent = character.document_count ||
                        '0';

                    // Set the image
                     // Set the image - Fix the image path handling
                    let imageUrl = '/static/images/dinosaur1.png'; // Default placeholder
                    
                    if (character.image_url) {
                        // Check if the image_url already starts with /static
                        if (character.image_url.startsWith('/static')) {
                            imageUrl = character.image_url;
                        } else {
                            // If it's just a filename or relative path, prepend /static/uploads/characters/
                            imageUrl = `/static/uploads/characters/${character.image_url.split('/').pop()}`;
                        }
                    }
                    
                    console.log('Character image URL:', imageUrl)
                    document.getElementById('preview-character-image').src = imageUrl;
                    document.getElementById('preview-character-image').onerror = function () {
                        this.src = '/static/images/dinosaur1.png';
                    };

                    // Set up the edit button
                    document.getElementById('preview-edit-character-btn').setAttribute('data-id', character.id);
                    document.getElementById('preview-edit-character-btn').onclick = function () {
                        // Close the preview modal
                        document.getElementById('characterPreviewModal').style.display = 'none';
                        // Open the edit modal
                        editCharacter(character.id);
                    };

                    // Show the modal
                    document.getElementById('characterPreviewModal').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error loading character details:', error);
                    const errorMsg = document.getElementById('character-error-message');
                    errorMsg.textContent = 'Failed to load character details';
                    errorMsg.style.display = 'block';
                    setTimeout(() => {
                        errorMsg.style.display = 'none';
                    }, 3000);
                });
        }

        // Add event listeners for the preview modal
        document.addEventListener('DOMContentLoaded', function() {
            // Close preview modal when X or Close is clicked
            document.querySelectorAll('#preview-close-btn, .preview-cancel-btn').forEach(element => {
                element.addEventListener('click', function() {
                    document.getElementById('characterPreviewModal').style.display = 'none';
                });
            });

            // Close preview modal when clicking outside of it
            window.addEventListener('click', function(event) {
                if (event.target === document.getElementById('characterPreviewModal')) {
                    document.getElementById('characterPreviewModal').style.display = 'none';
                }
            });
        });
        // Function to properly close the character preview modal
        function closeCharacterPreviewModal() {
            // Get the modal instance
            const previewModal = bootstrap.Modal.getInstance(document.getElementById('characterPreviewModal'));
            if (previewModal) {
                previewModal.hide();
            }

            // Remove any modal backdrops
            setTimeout(() => {
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => {
                    backdrop.remove();
                });
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            }, 300); // Small delay to allow the modal hide animation to complete
        }

        // Function to upload character image
        function uploadCharacterImage(characterId) {
            // Create a file input element
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';

            // Trigger click on the file input
            fileInput.click();

            // Handle file selection
            fileInput.addEventListener('change', function () {
                if (this.files && this.files[0]) {
                    const file = this.files[0];

                    // Create FormData
                    const formData = new FormData();
                    formData.append('image', file);

                    // Show loading message
                    const successMsg = document.getElementById('character-success-message');
                    successMsg.textContent = 'Uploading image...';
                    successMsg.style.display = 'block';

                    // Upload the image
                    fetch(`/api/v1/characters/${characterId}/image`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                            },
                            body: formData
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to upload image');
                            }
                            return response.json();
                        })
                        .then(data => {
                            // Show success message
                            successMsg.textContent = 'Image uploaded successfully';
                            setTimeout(() => {
                                successMsg.style.display = 'none';
                            }, 3000);

                            // Reload characters to show the new image
                            loadCharacters();
                        })
                        .catch(error => {
                            console.error('Error uploading image:', error);
                            const errorMsg = document.getElementById('character-error-message');
                            errorMsg.textContent = 'Failed to upload image: ' + error.message;
                            errorMsg.style.display = 'block';
                            successMsg.style.display = 'none';
                            setTimeout(() => {
                                errorMsg.style.display = 'none';
                            }, 3000);
                        });
                }
            });
        }

        
    </script>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ... existing script code ...

        // Add character modal functionality
        const characterModal = document.getElementById('character-modal');
        const addCharacterBtn = document.getElementById('add-character-btn');
        const saveCharacterBtn = document.getElementById('save-character-btn');
        const characterForm = document.getElementById('character-form');

        
        // Open modal when Add New Character button is clicked
        addCharacterBtn.addEventListener('click', function () {
            // Reset form
             characterForm.reset();
            document.getElementById('character-modal-title').textContent = 'Add New Character';
            const saveBtn = document.getElementById('save-character-btn');
            saveBtn.textContent = 'Save Character';
            saveBtn.removeAttribute('data-id');
            saveBtn.setAttribute('data-mode', 'create');
            characterModal.style.display = 'block';
        });

        // Close modal when X or Cancel is clicked
        document.querySelectorAll('#character-modal .close, #character-modal .cancel-btn').forEach(element => {
            element.addEventListener('click', function () {
                characterModal.style.display = 'none';
            });
        });

        // Close modal when clicking outside of it
        window.addEventListener('click', function (event) {
            if (event.target === characterModal) {
                characterModal.style.display = 'none';
            }
        });

      saveCharacterBtn.addEventListener('click', async function () {
            // Validate form
            if (!characterForm.checkValidity()) {
                characterForm.reportValidity();
                return;
            }

            // Get form data
            const formData = new FormData(characterForm);
            const characterData = {
                character_id: formData.get('character_id'),
                name: formData.get('name'),
                description: formData.get('description'),
                backstory: formData.get('backstory') || '',
                personality: formData.get('personality') || '',
                system_prompt: formData.get('system_prompt') || ''
            };

            try {
                // Show loading state
                saveCharacterBtn.disabled = true;
                saveCharacterBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

                // Determine if this is a create or update operation
                const isEdit = saveCharacterBtn.getAttribute('data-mode') === 'edit';
                const characterId = isEdit ? saveCharacterBtn.getAttribute('data-id') : null;
                
                // API endpoint and method
                const url = isEdit 
                    ? `/api/v1/characters/${characterId}` 
                    : '/api/v1/characters/';
                const method = isEdit ? 'PUT' : 'POST';

                // Create or update character
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify(characterData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `Failed to ${isEdit ? 'update' : 'create'} character`);
                }

                const character = await response.json();

                // Handle image upload if provided
                const imageFile = document.getElementById('character-image').files[0];
                if (imageFile) {
                    const imageFormData = new FormData();
                    imageFormData.append('image', imageFile);

                    const imageResponse = await fetch(`/api/v1/characters/${isEdit ? characterId : character.id}/image`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                        },
                        body: imageFormData
                    });

                    if (!imageResponse.ok) {
                        console.error('Failed to upload character image');
                    }
                }

                // Show success message
                const successMessage = document.getElementById('character-success-message');
                successMessage.textContent = `Character ${isEdit ? 'updated' : 'created'} successfully`;
                successMessage.style.display = 'block';

                // Auto-hide message after 5 seconds
                setTimeout(() => {
                    successMessage.style.display = 'none';
                }, 5000);

                // Close modal
                characterModal.style.display = 'none';

                // Reload characters
                if (document.querySelector('.content-section.active').id === 'characters-section') {
                    loadAllCharacters();
                } else {
                    // If on dashboard, reload dashboard data
                    loadDashboardData();
                }
            } catch (error) {
                console.error(`Error ${saveCharacterBtn.getAttribute('data-mode') === 'edit' ? 'updating' : 'creating'} character:`, error);

                // Show error message
                const errorMessage = document.getElementById('character-error-message');
                errorMessage.textContent = error.message;
                errorMessage.style.display = 'block';

                // Auto-hide message after 5 seconds
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 5000);
            } finally {
                // Reset button state
                saveCharacterBtn.disabled = false;
                saveCharacterBtn.innerHTML = saveCharacterBtn.getAttribute('data-mode') === 'edit' ? 'Update Character' : 'Save Character';
            }
        });
    </script>

        <script>
        // Mobile sidebar toggle
        document.getElementById('mobile-toggle').addEventListener('click', function () {
            document.getElementById('sidebar').classList.add('active');
        });

        // ... existing code ...

        // Add event listener for the users menu item
        document.querySelectorAll('.menu-item').forEach(item => {
            if (item.getAttribute('data-section') === 'users') {
                item.addEventListener('click', loadAllUsers);
            }
        });

        

        // Function to load all users
        async function loadAllUsers() {
            try {
                const usersTableBody = document.getElementById('users-table-body');
                usersTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Loading users...</p>
                        </td>
                    </tr>
                `;

                const response = await fetch('/api/v1/admin/users', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load users');
                }

                const users = await response.json();
                usersTableBody.innerHTML = '';

                if (users.length === 0) {
                    usersTableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="empty-state">
                                <i class="fas fa-users-slash"></i>
                                <p>No users found.</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                users.forEach(user => {
                    // Determine status badge
                    let statusBadge = '';
                    if (!user.is_active) {
                        statusBadge = '<span class="badge bg-danger">Inactive</span>';
                    } else if (!user.is_approved) {
                        statusBadge = '<span class="badge bg-warning">Pending Approval</span>';
                    } else {
                        statusBadge = '<span class="badge bg-success">Active</span>';
                    }

                    // Determine role badge
                    let roleBadge = '';
                    if (user.is_super_admin) {
                        roleBadge = '<span class="badge bg-danger">Super Admin</span>';
                    } else if (user.is_admin) {
                        roleBadge = '<span class="badge bg-primary">Admin</span>';
                    } else {
                        roleBadge = '<span class="badge bg-secondary">User</span>';
                    }

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.username}</td>
                        <td>${user.email}</td>
                        <td>${statusBadge}</td>
                        <td>${roleBadge}</td>
                        <td>${new Date(user.created_at).toLocaleDateString()}</td>
                        <td>
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary btn-sm view-user" data-id="${user.id}">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                ${!user.is_approved && user.is_active ? 
                                    `<button class="btn btn-success btn-sm approve-user" data-id="${user.id}">
                                        <i class="fas fa-check"></i> Approve
                                    </button>` : ''}
                                ${user.is_active ? 
                                    `<button class="btn btn-warning btn-sm deactivate-user" data-id="${user.id}">
                                        <i class="fas fa-ban"></i> Deactivate
                                    </button>` : 
                                    `<button class="btn btn-success btn-sm activate-user" data-id="${user.id}">
                                        <i class="fas fa-check"></i> Activate
                                    </button>`}
                            </div>
                        </td>
                    `;
                    usersTableBody.appendChild(row);
                });

                // Add event listeners to the buttons
                setupUserActionListeners();
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('users-table-body').innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <i class="fas fa-exclamation-circle" style="color: #dc3545;"></i>
                            <p>Failed to load users. Please try again.</p>
                        </td>
                    </tr>
                `;

                // If unauthorized, redirect to login
                if (error.message.includes('401')) {
                    localStorage.removeItem('access_token');
                    window.location.href = '/';
                }
            }
        }

        function setupUserActionListeners() {
            // View user
            document.querySelectorAll('.view-user').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = this.getAttribute('data-id');
                    viewUser(userId);
                });
            });

            // Approve user
            document.querySelectorAll('.approve-user').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = this.getAttribute('data-id');
                    approveUser(userId);
                });
            });

            // Deactivate user
            document.querySelectorAll('.deactivate-user').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = this.getAttribute('data-id');
                    deactivateUser(userId);
                });
            });

            // Activate user
            document.querySelectorAll('.activate-user').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = this.getAttribute('data-id');
                    activateUser(userId);
                });
            });
        }

        async function viewUser(userId) {
            try {
                // Show loading state
        document.getElementById('user-characters-container').innerHTML = '<p class="text-muted">Loading characters...</p>';
        document.getElementById('user-documents-container').innerHTML = '<p class="text-muted">Loading documents...</p>';
                const response = await fetch(`/api/v1/admin/users/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load user details');
                }

                const user = await response.json();
                
                // Set user details in the modal
                document.getElementById('user-details-username').textContent = user.username ||user.email;;
                document.getElementById('user-details-email').textContent = user.email;
                
                // Set status
                let statusText = '';
                if (!user.is_active) {
                    statusText = '<span class="badge bg-danger">Inactive</span>';
                } else if (!user.is_approved) {
                    statusText = '<span class="badge bg-warning">Pending Approval</span>';
                } else {
                    statusText = '<span class="badge bg-success">Active</span>';
                }
                document.getElementById('user-details-status').innerHTML = statusText;
                
                // Set role
                let roleText = '';
                if (user.is_super_admin) {
                    roleText = '<span class="badge bg-danger">Super Admin</span>';
                } else if (user.is_admin) {
                    roleText = '<span class="badge bg-primary">Admin</span>';
                } else {
                    roleText = '<span class="badge bg-secondary">User</span>';
                }
                document.getElementById('user-details-role').innerHTML = roleText;
                
                // Set created date
                document.getElementById('user-details-created').textContent = new Date(user.created_at).toLocaleString();
                
                // Set action buttons visibility
                const approveBtn = document.getElementById('approve-user-btn');
                const deactivateBtn = document.getElementById('deactivate-user-btn');
                const activateBtn = document.getElementById('activate-user-btn');
                
                // Reset all buttons
                approveBtn.style.display = 'none';
                deactivateBtn.style.display = 'none';
                activateBtn.style.display = 'none';
                
                // Show appropriate buttons based on user status
                if (user.is_active && !user.is_approved) {
                    approveBtn.style.display = 'block';
                    approveBtn.setAttribute('data-id', user.id);
                }
                
                if (user.is_active) {
                    deactivateBtn.style.display = 'block';
                    deactivateBtn.setAttribute('data-id', user.id);
                } else {
                    activateBtn.style.display = 'block';
                    activateBtn.setAttribute('data-id', user.id);
                }
                
                // Load user's characters and documents
                loadUserCharacters(userId);
                loadUserDocuments(userId);
                
                // Show the modal
                 document.getElementById('userDetailsModal').style.display = 'block';
               
                
                // document.getElementById('deactivate-user-btn').onclick = function() {
                //     const userId = this.getAttribute('data-id');
                //     userDetailsModal.hide();
                //     deactivateUser(userId);
                // };
                
                // document.getElementById('activate-user-btn').onclick = function() {
                //     const userId = this.getAttribute('data-id');
                //     userDetailsModal.hide();
                //     activateUser(userId);
                // };
                
                // // Close buttons
                // document.getElementById('userDetailsModal').style.display = 'none';
                
                // document.getElementById('user-details-close-btn-footer').onclick = function() {
                //     userDetailsModal.hide();
                // };
                
            } catch (error) {
                console.error('Error viewing user:', error);
                alert('Failed to load user details. Please try again.');
            }
        }
        // Add event listeners for user details modal
document.addEventListener('DOMContentLoaded', function() {
    // Close modal when clicking the X or Cancel button
    document.querySelectorAll('#userDetailsModal .close, #userDetailsModal .cancel-btn, .close-footer').forEach(element => {
        element.addEventListener('click', function() {
            document.getElementById('userDetailsModal').style.display = 'none';
        });
    });
    
    // Close modal when clicking outside of it
    window.addEventListener('click', function(event) {
        if (event.target === document.getElementById('userDetailsModal')) {
            document.getElementById('userDetailsModal').style.display = 'none';
        }
    });
    
    // Set up action buttons in the modal
    document.getElementById('approve-user-btn').addEventListener('click', function() {
        const userId = this.getAttribute('data-id');
        document.getElementById('userDetailsModal').style.display = 'none';
        approveUser(userId);
    });
    
    document.getElementById('deactivate-user-btn').addEventListener('click', function() {
        const userId = this.getAttribute('data-id');
        document.getElementById('userDetailsModal').style.display = 'none';
        deactivateUser(userId);
    });
    
    document.getElementById('activate-user-btn').addEventListener('click', function() {
        const userId = this.getAttribute('data-id');
        document.getElementById('userDetailsModal').style.display = 'none';
        activateUser(userId);
    });
});
        
        async function loadUserCharacters(userId) {
            try {
                const response = await fetch(`/api/v1/admin/users/${userId}/characters`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load user characters');
                }
                
                const characters = await response.json();
                const container = document.getElementById('user-characters-container');
                document.getElementById('user-character-count').textContent = characters.length;
                
                if (characters.length === 0) {
                    container.innerHTML = '<p class="text-muted">No characters created by this user.</p>';
                    return;
                }
                
                let html = '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>Name</th><th>Description</th><th>Created</th></tr></thead><tbody>';
                
                characters.forEach(character => {
                    html += `
                        <tr>
                            <td>${character.name}</td>
                            <td>${character.description ? (character.description.length > 50 ? character.description.substring(0, 50) + '...' : character.description) : 'No description'}</td>
                            <td>${new Date(character.created_at).toLocaleDateString()}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading user characters:', error);
                document.getElementById('user-characters-container').innerHTML = '<p class="text-danger">Failed to load characters.</p>';
            }
        }
        
        async function loadUserDocuments(userId) {
            try {
                const response = await fetch(`/api/v1/admin/users/${userId}/documents`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load user documents');
                }
                
                const documents = await response.json();
                const container = document.getElementById('user-documents-container');
                document.getElementById('user-document-count').textContent = documents.length;
                
                if (documents.length === 0) {
                    container.innerHTML = '<p class="text-muted">No documents uploaded by this user.</p>';
                    return;
                }
                
                let html = '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>Title</th><th>Type</th><th>Created</th></tr></thead><tbody>';
                
                documents.forEach(doc => {
                    html += `
                        <tr>
                            <td>${doc.title}</td>
                            <td>${doc.document_type}</td>
                            <td>${new Date(doc.created_at).toLocaleDateString()}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading user documents:', error);
                document.getElementById('user-documents-container').innerHTML = '<p class="text-danger">Failed to load documents.</p>';
            }
        }
        
        async function approveUser(userId) {
            if (confirm('Are you sure you want to approve this user?')) {
                try {
                    const response = await fetch(`/api/v1/admin/users/${userId}/approve`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to approve user');
                    }
                    
                    // Show success message
                    const successMsg = document.getElementById('user-success-message');
                    successMsg.textContent = 'User approved successfully';
                    successMsg.style.display = 'block';
                    
                    // Reload users list
                    loadAllUsers();
                    
                    // Hide message after 3 seconds
                    setTimeout(() => {
                        successMsg.style.display = 'none';
                    }, 3000);
                    
                } catch (error) {
                    console.error('Error approving user:', error);
                    
                    // Show error message
                    const errorMsg = document.getElementById('user-error-message');
                    errorMsg.textContent = 'Failed to approve user';
                    errorMsg.style.display = 'block';
                    
                    // Hide message after 3 seconds
                    setTimeout(() => {
                        errorMsg.style.display = 'none';
                    }, 3000);
                }
            }
        }
        
        async function deactivateUser(userId) {
            if (confirm('Are you sure you want to deactivate this user?')) {
                try {
                    const response = await fetch(`/api/v1/admin/users/${userId}/deactivate`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to deactivate user');
                    }
                    
                    // Show success message
                    const successMsg = document.getElementById('user-success-message');
                    successMsg.textContent = 'User deactivated successfully';
                    successMsg.style.display = 'block';
                    
                    // Reload users list
                    loadAllUsers();
                    
                    // Hide message after 3 seconds
                    setTimeout(() => {
                        successMsg.style.display = 'none';
                    }, 3000);
                    
                } catch (error) {
                    console.error('Error deactivating user:', error);
                    
                    // Show error message
                    const errorMsg = document.getElementById('user-error-message');
                    errorMsg.textContent = 'Failed to deactivate user';
                    errorMsg.style.display = 'block';
                    
                    // Hide message after 3 seconds
                    setTimeout(() => {
                        errorMsg.style.display = 'none';
                    }, 3000);
                }
            }
        }
        
        async function activateUser(userId) {
            if (confirm('Are you sure you want to activate this user?')) {
                try {
                    const response = await fetch(`/api/v1/admin/users/${userId}/activate`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to activate user');
                    }
                    
                    // Show success message
                    const successMsg = document.getElementById('user-success-message');
                    successMsg.textContent = 'User activated successfully';
                    successMsg.style.display = 'block';
                    
                    // Reload users list
                    loadAllUsers();
                    
                    // Hide message after 3 seconds
                    setTimeout(() => {
                        successMsg.style.display = 'none';
                    }, 3000);
                    
                } catch (error) {
                    console.error('Error activating user:', error);
                    
                    // Show error message
                    const errorMsg = document.getElementById('user-error-message');
                    errorMsg.textContent = 'Failed to activate user';
                    errorMsg.style.display = 'block';
                    
                    // Hide message after 3 seconds
                    setTimeout(() => {
                        errorMsg.style.display = 'none';
                    }, 3000);
                }
            }
        }
            // Document auto-refresh functionality
    document.addEventListener('DOMContentLoaded', function() {
        const refreshForm = document.getElementById('refresh-settings-form');
        const refreshNowBtn = document.getElementById('refresh-now-btn');
        const autoRefreshToggle = document.getElementById('auto-refresh-toggle');
        const refreshStatusCard = document.getElementById('refresh-status-card');
        const refreshProgressBar = document.getElementById('refresh-progress-bar');
        const refreshProgressText = document.getElementById('refresh-progress-text');
        const lastRefreshTime = document.getElementById('last-refresh-time');
        const refreshResult = document.getElementById('refresh-result');
        
        // Load saved settings
        loadRefreshSettings();
        
        // Save settings when form is submitted
        refreshForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const saveButton = this.querySelector('button[type="submit"]');
            const originalButtonText = saveButton.innerHTML;
            saveButton.disabled = true;
            saveButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
            const refreshInterval = document.getElementById('refresh-interval').value;
            const refreshIntervalUnit = document.getElementById('refresh-interval-unit').value;
            const autoRefreshEnabled = autoRefreshToggle.checked;
            
            if (refreshInterval < 1) {
                showDocumentMessage('error', 'Refresh interval must be at least 1');
               saveButton.disabled = false;
                saveButton.innerHTML = originalButtonText;
                return;
            }
            
            // Convert to hours based on selected unit
            let hoursValue = parseInt(refreshInterval);
            if (refreshIntervalUnit === 'days') {
                hoursValue *= 24;
            } else if (refreshIntervalUnit === 'weeks') {
                hoursValue *= 24 * 7;
            }
            
            try {
                const response = await fetch('/api/v1/document-refresh/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify({ 
                        hours: hoursValue,
                        enabled: autoRefreshEnabled
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update refresh settings');
                }
                
                const result = await response.json();
                showDocumentMessage('success', result.message);
                
                // Save settings to localStorage
                saveRefreshSettings(refreshInterval, refreshIntervalUnit, autoRefreshEnabled);
                
            } catch (error) {
                console.error('Error updating refresh settings:', error);
                showDocumentMessage('error', 'Failed to update refresh settings');
            }finally {
                // Reset button state
                saveButton.disabled = false;
                saveButton.innerHTML = originalButtonText;
            }
        });
        
        // Handle manual refresh
        refreshNowBtn.addEventListener('click', async function() {
            try {
                refreshNowBtn.disabled = true;
                refreshNowBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
                
                // Start the refresh process
                const response = await fetch('/api/v1/document-refresh/now', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to trigger document refresh');
                }
                
                const result = await response.json();
                showDocumentMessage('success', 'Document refresh process started');
                
                // Start polling for progress updates
                startProgressPolling();
                
            } catch (error) {
                console.error('Error triggering refresh:', error);
                showDocumentMessage('error', 'Failed to trigger document refresh');
                refreshNowBtn.disabled = false;
                refreshNowBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Now';
            }
        });
        
        // Toggle auto-refresh
        autoRefreshToggle.addEventListener('change', function() {
            const isEnabled = this.checked;
            saveRefreshSettings(
                document.getElementById('refresh-interval').value,
                document.getElementById('refresh-interval-unit').value,
                isEnabled
            );
            
            // Update the server with the new setting
            fetch('/api/v1/document-refresh/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                },
                body: JSON.stringify({ 
                    enabled: isEnabled,
                    hours: getHoursValue()
                })
            }).catch(error => {
                console.error('Error updating auto-refresh setting:', error);
            });
        });
        
        // Helper function to get hours value based on current form values
        function getHoursValue() {
            const refreshInterval = document.getElementById('refresh-interval').value;
            const refreshIntervalUnit = document.getElementById('refresh-interval-unit').value;
            
            let hoursValue = parseInt(refreshInterval);
            if (refreshIntervalUnit === 'days') {
                hoursValue *= 24;
            } else if (refreshIntervalUnit === 'weeks') {
                hoursValue *= 24 * 7;
            }
            
            return hoursValue;
        }
        
        // Save refresh settings to localStorage
        function saveRefreshSettings(interval, unit, enabled) {
            const settings = {
                interval: interval,
                unit: unit,
                enabled: enabled,
                lastSaved: new Date().toISOString()
            };
             // Preserve the last refresh time if it exists
            const savedSettings = localStorage.getItem('documentRefreshSettings');
            if (savedSettings) {
                try {
                    const oldSettings = JSON.parse(savedSettings);
                    if (oldSettings.lastRefreshTime) {
                        settings.lastRefreshTime = oldSettings.lastRefreshTime;
                        settings.lastRefreshResult = oldSettings.lastRefreshResult;
                    }
                } catch (e) {
                    console.error('Error parsing saved settings:', e);
                }
            }
            localStorage.setItem('documentRefreshSettings', JSON.stringify(settings));
        }
        
        // Load refresh settings from localStorage
        function loadRefreshSettings() {
            const savedSettings = localStorage.getItem('documentRefreshSettings');
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    document.getElementById('refresh-interval').value = settings.interval || 24;
                    document.getElementById('refresh-interval-unit').value = settings.unit || 'hours';
                    document.getElementById('auto-refresh-toggle').checked = settings.enabled !== false;
                // Display saved last refresh time if available
                    if (settings.lastRefreshTime) {
                        lastRefreshTime.textContent = new Date(settings.lastRefreshTime).toLocaleString();
                        refreshResult.textContent = settings.lastRefreshResult || 'Completed';
                    }
                } catch (e) {
                    console.error('Error parsing saved refresh settings:', e);
                }
            }
            
            // Also fetch current settings from server
            fetch('/api/v1/document-refresh/settings', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.last_refresh) {
                    lastRefreshTime.textContent = new Date(data.last_refresh).toLocaleString();
                    // Save the last refresh time to localStorage
                    updateLastRefreshInStorage(data.last_refresh, data.status || 'Completed');
                }
                if (data.status) {
                    refreshResult.textContent = data.status;
                }
                
                // Update form with server values if available
                if (data.hours !== undefined) {
                    // Convert hours to appropriate unit
                    let interval = data.hours;
                    let unit = 'hours';
                    
                    if (interval % (24 * 7) === 0) {
                        interval = interval / (24 * 7);
                        unit = 'weeks';
                    } else if (interval % 24 === 0) {
                        interval = interval / 24;
                        unit = 'days';
                    }
                    
                    document.getElementById('refresh-interval').value = interval;
                    document.getElementById('refresh-interval-unit').value = unit;
                }
                
                if (data.enabled !== undefined) {
                    document.getElementById('auto-refresh-toggle').checked = data.enabled;
                }
            })
            .catch(error => {
                console.error('Error fetching refresh settings:', error);
            });
        }
        // Helper function to update last refresh time in localStorage
        function updateLastRefreshInStorage(timestamp, result) {
            const savedSettings = localStorage.getItem('documentRefreshSettings');
            let settings = {};
            
            if (savedSettings) {
                try {
                    settings = JSON.parse(savedSettings);
                } catch (e) {
                    console.error('Error parsing saved settings:', e);
                }
            }
            
            settings.lastRefreshTime = timestamp;
            settings.lastRefreshResult = result;
            localStorage.setItem('documentRefreshSettings', JSON.stringify(settings));
        }
        // Poll for refresh progress
        function startProgressPolling() {
            refreshStatusCard.style.display = 'block';
            
            const pollInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/v1/document-refresh/status', {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to get refresh status');
                    }
                    
                    const data = await response.json();
                    
                    // Update progress bar
                    const percentage = data.total > 0 ? Math.round((data.processed / data.total) * 100) : 0;
                    refreshProgressBar.style.width = `${percentage}%`;
                    refreshProgressBar.textContent = `${percentage}%`;
                    refreshProgressBar.setAttribute('aria-valuenow', percentage);
                    
                    // Update progress text
                    refreshProgressText.textContent = `Processing documents: ${data.processed} of ${data.total}`;
                    
                    // If complete, stop polling
                    if (data.status === 'completed' || data.status === 'failed') {
                        clearInterval(pollInterval);
                        
                        // Update UI
                        setTimeout(() => {
                            refreshStatusCard.style.display = 'none';
                            refreshNowBtn.disabled = false;
                            refreshNowBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Now';
                            const currentTime = new Date().toISOString();
                             // Update last refresh time
                            lastRefreshTime.textContent = new Date(currentTime).toLocaleString();
                            const resultText = data.status === 'completed' ? 
                                `Successfully refreshed ${data.processed} documents.` : 
                                `Refresh process failed after processing ${data.processed} documents.`;
                            refreshResult.textContent = resultText;
                            
                            // Save to localStorage
                            updateLastRefreshInStorage(currentTime, resultText);
                            // Show message
                            showDocumentMessage(
                                data.status === 'completed' ? 'success' : 'error',
                                data.status === 'completed' ? 
                                    `Document refresh completed. ${data.processed} documents processed.` : 
                                    `Document refresh failed after processing ${data.processed} documents.`
                            );
                        }, 1000);
                    }
                    
                } catch (error) {
                    console.error('Error polling refresh status:', error);
                }
            }, 2000); // Poll every 2 seconds
        }
        
        // Show document success/error message
        function showDocumentMessage(type, message) {
            const messageElement = type === 'success' ? 
                document.getElementById('document-success-message') : 
                document.getElementById('document-error-message');
            
            messageElement.textContent = message;
            messageElement.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 5000);
        }
        
        // Check if a refresh is already in progress when the page loads
        fetch('/api/v1/document-refresh/status', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'in_progress') {
                refreshNowBtn.disabled = true;
                startProgressPolling();
            }
        })
        .catch(error => {
            console.error('Error checking refresh status:', error);
        });
    });

    </script>

    

</body>

</html>